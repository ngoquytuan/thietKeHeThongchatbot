FR-02.2 - API Quáº£n trá»‹ Thá»‘ng nháº¥t

Cung cáº¥p RESTful API cho cÃ¡c thao tÃ¡c CRUD
Endpoint chÃ­nh:
/api/documents - Quáº£n lÃ½ tÃ i liá»‡u
/api/users - Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
/api/search - TÃ¬m kiáº¿m tÃ i liá»‡u
/api/access-control - Quáº£n lÃ½ phÃ¢n quyá»n
---
# TÃ€I LIá»†U THIáº¾T Káº¾ Ká»¸ THUáº¬T
## FR-02.2 - API QUáº¢N TRá»Š THá»NG NHáº¤T
### UNIFIED MANAGEMENT API DESIGN SPECIFICATION

---

**PhiÃªn báº£n:** 1.0  
**NgÃ y:** 31/08/2025  
**Module:** FR-02.2 - API Quáº£n trá»‹ Thá»‘ng nháº¥t  
**NgÆ°á»i soáº¡n tháº£o:** Technical Design Team  
**Tráº¡ng thÃ¡i:** Implementation Ready  

---

## 1. Tá»”NG QUAN MODULE

### 1.1 Má»¥c tiÃªu
XÃ¢y dá»±ng RESTful API Gateway thá»‘ng nháº¥t cung cáº¥p interface chuáº©n cho táº¥t cáº£ cÃ¡c thao tÃ¡c CRUD cá»§a há»‡ thá»‘ng Trá»£ lÃ½ Tri thá»©c Ná»™i bá»™.

### 1.2 Pháº¡m vi
- **Documents API**: `/api/documents` - Quáº£n lÃ½ tÃ i liá»‡u
- **Users API**: `/api/users` - Quáº£n lÃ½ ngÆ°á»i dÃ¹ng  
- **Search API**: `/api/search` - TÃ¬m kiáº¿m tÃ i liá»‡u
- **Access Control API**: `/api/access-control` - Quáº£n lÃ½ phÃ¢n quyá»n

### 1.3 Kiáº¿n trÃºc tá»•ng quan
```mermaid
graph TB
    Client[Client Applications] --> Gateway[API Gateway]
    Gateway --> Auth[Authentication Layer]
    Gateway --> Rate[Rate Limiting]
    Gateway --> Router[Request Router]
    
    Router --> DocAPI[Documents API]
    Router --> UserAPI[Users API] 
    Router --> SearchAPI[Search API]
    Router --> AccessAPI[Access Control API]
    
    DocAPI --> VectorDB[(Vector DB)]
    DocAPI --> PostgreSQL[(PostgreSQL)]
    UserAPI --> PostgreSQL
    SearchAPI --> VectorDB
    SearchAPI --> Elasticsearch[(Elasticsearch)]
    AccessAPI --> PostgreSQL
```

---

## 2. CHUáº¨N Bá»Š MÃ”I TRÆ¯á»œNG PHÃT TRIá»‚N

### 2.1 YÃªu cáº§u pháº§n cá»©ng tá»‘i thiá»ƒu

| Component | Minimum | Recommended |
|-----------|---------|-------------|
| **CPU** | 4 cores (Intel i5/AMD Ryzen 5) | 8 cores (Intel i7/AMD Ryzen 7) |
| **RAM** | 16GB | 32GB |
| **Storage** | 500GB SSD | 1TB NVMe SSD |
| **Network** | 1Gbps | 10Gbps |

### 2.2 Há»‡ Ä‘iá»u hÃ nh & Software stack

#### **Há»‡ Ä‘iá»u hÃ nh há»— trá»£:**
- **Ubuntu 22.04 LTS** (Recommended)
- **CentOS Stream 9**  
- **macOS 12+** (Development only)
- **Windows 11** vá»›i WSL2 (Development only)

#### **Core Development Stack:**
```bash
# Programming Language
Python 3.11+

# Web Framework  
FastAPI 0.104+
Uvicorn 0.24+ (ASGI Server)

# Database Drivers
psycopg2-binary 2.9+ (PostgreSQL)
chromadb 0.4+ (Vector DB)
elasticsearch 8.0+ (Full-text search)

# Authentication & Security
python-jose 3.3+ (JWT)
passlib 1.7+ (Password hashing)
python-multipart 0.0.6+ (File uploads)

# API Documentation
openapi-generator 7.0+
redoc 2.1+

# Testing Framework
pytest 7.4+
httpx 0.25+ (Async HTTP client for testing)
```

### 2.3 CÃ i Ä‘áº·t mÃ´i trÆ°á»ng tá»«ng bÆ°á»›c

#### **BÆ°á»›c 1: Chuáº©n bá»‹ há»‡ thá»‘ng (Ubuntu 22.04)**
```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install essential packages
sudo apt install -y curl wget git vim build-essential

# Install Python 3.11
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip

# Install Docker & Docker Compose
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Install Node.js (for API documentation tools)
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs
```

#### **BÆ°á»›c 2: Setup Python Virtual Environment**
```bash
# Create project directory
mkdir -p ~/projects/knowledge-assistant-api
cd ~/projects/knowledge-assistant-api

# Create virtual environment
python3.11 -m venv venv
source venv/bin/activate

# Upgrade pip
pip install --upgrade pip setuptools wheel
```

#### **BÆ°á»›c 3: Install Core Dependencies**
```bash
# Create requirements.txt
cat > requirements.txt << EOF
# Web Framework
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.4.2
pydantic-settings==2.0.3

# Database & Storage
psycopg2-binary==2.9.7
chromadb==0.4.15
elasticsearch==8.10.1
redis==5.0.1

# Authentication & Security  
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6

# HTTP & Async
httpx==0.25.0
aiofiles==23.2.1

# Utilities
python-dotenv==1.0.0
loguru==0.7.2
typer==0.9.0

# Testing
pytest==7.4.3
pytest-asyncio==0.21.1
httpx==0.25.0

# Development
black==23.9.1
isort==5.12.0
flake8==6.1.0
mypy==1.6.1
EOF

# Install dependencies
pip install -r requirements.txt
```

#### **BÆ°á»›c 4: Setup Database Services (Docker)**
```bash
# Create docker-compose.yml for development
cat > docker-compose.dev.yml << 'EOF'
version: '3.8'

services:
  postgres:
    image: postgres:15
    container_name: ka-postgres
    environment:
      POSTGRES_DB: knowledge_assistant
      POSTGRES_USER: ka_user
      POSTGRES_PASSWORD: ka_password_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: ka-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.1
    container_name: ka-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  es_data:
EOF

# Start services
docker-compose -f docker-compose.dev.yml up -d
```

#### **BÆ°á»›c 5: Project Structure Setup**
```bash
# Create project structure
mkdir -p {app,tests,docs,scripts,config}
mkdir -p app/{api,core,models,services,utils}
mkdir -p app/api/{endpoints,dependencies}
mkdir -p tests/{unit,integration,e2e}

# Create basic files
touch app/__init__.py
touch app/main.py
touch app/core/{__init__.py,config.py,security.py,database.py}
touch app/models/{__init__.py,users.py,documents.py,permissions.py}
touch app/services/{__init__.py,user_service.py,document_service.py,search_service.py}
touch app/api/{__init__.py,router.py}
touch app/api/endpoints/{__init__.py,documents.py,users.py,search.py,access_control.py}
```

---

## 3. THIáº¾T Káº¾ API SPECIFICATION

### 3.1 API Authentication & Security

#### **JWT Token Structure:**
```json
{
  "sub": "user_id_123",
  "username": "john.doe", 
  "email": "john@company.com",
  "role": "employee|manager|director|admin",
  "department": "rd|sales|production",
  "permissions": ["read:documents", "write:documents"],
  "exp": 1698234567,
  "iat": 1698230967
}
```

#### **Security Headers:**
```http
Authorization: Bearer <jwt_token>
Content-Type: application/json
X-API-Version: v1
X-Request-ID: uuid4()
```

### 3.2 Standard Response Format

#### **Success Response:**
```json
{
  "success": true,
  "data": {
    // Actual response data
  },
  "metadata": {
    "timestamp": "2025-08-31T10:30:00Z",
    "request_id": "req_123456789",
    "version": "v1",
    "total_count": 100,
    "page": 1,
    "page_size": 20
  }
}
```

#### **Error Response:**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": [
      {
        "field": "email",
        "message": "Invalid email format"
      }
    ]
  },
  "metadata": {
    "timestamp": "2025-08-31T10:30:00Z", 
    "request_id": "req_123456789",
    "version": "v1"
  }
}
```

### 3.3 API Endpoints Chi tiáº¿t

#### **3.3.1 Documents API (`/api/documents`)**

**POST /api/documents** - Upload document
```http
POST /api/documents
Content-Type: multipart/form-data

Form Data:
- file: [binary file]
- metadata: {
    "title": "Company Policy 2025",
    "department": "hr", 
    "access_level": "employee_only",
    "tags": ["policy", "hr", "2025"],
    "description": "Updated company policy"
  }
```

**GET /api/documents** - List documents
```http
GET /api/documents?page=1&page_size=20&department=rd&access_level=employee_only&search=policy

Response:
{
  "success": true,
  "data": [
    {
      "id": "doc_12345",
      "title": "R&D Process Guide",
      "department": "rd",
      "access_level": "employee_only", 
      "author": "john.doe",
      "created_at": "2025-08-31T10:00:00Z",
      "updated_at": "2025-08-31T10:00:00Z",
      "file_size": 2048576,
      "file_type": "pdf",
      "tags": ["process", "rd", "guide"],
      "download_url": "/api/documents/doc_12345/download"
    }
  ],
  "metadata": {
    "total_count": 150,
    "page": 1, 
    "page_size": 20
  }
}
```

**GET /api/documents/{doc_id}** - Get document details
**PUT /api/documents/{doc_id}** - Update document metadata
**DELETE /api/documents/{doc_id}** - Delete document
**GET /api/documents/{doc_id}/download** - Download original file

#### **3.3.2 Users API (`/api/users`)**

**POST /api/users** - Create user
```json
{
  "username": "jane.smith",
  "email": "jane.smith@company.com", 
  "full_name": "Jane Smith",
  "department": "sales",
  "role": "employee",
  "is_active": true
}
```

**GET /api/users** - List users with filtering
**GET /api/users/{user_id}** - Get user details  
**PUT /api/users/{user_id}** - Update user
**DELETE /api/users/{user_id}** - Deactivate user
**POST /api/users/{user_id}/reset-password** - Reset password

#### **3.3.3 Search API (`/api/search`)**

**POST /api/search** - Advanced search
```json
{
  "query": "machine learning model deployment",
  "search_type": "semantic|keyword|hybrid",
  "filters": {
    "department": ["rd", "engineering"],
    "access_level": ["employee_only", "public"],
    "file_type": ["pdf", "docx"],
    "date_range": {
      "from": "2025-01-01",
      "to": "2025-08-31"
    }
  },
  "options": {
    "max_results": 10,
    "include_snippets": true,
    "highlight": true
  }
}
```

**GET /api/search/suggestions** - Get search suggestions
**GET /api/search/popular** - Popular search terms

#### **3.3.4 Access Control API (`/api/access-control`)**

**POST /api/access-control/permissions** - Grant permission
```json
{
  "user_id": "user_123",
  "resource_type": "document",
  "resource_id": "doc_456", 
  "permission": "read|write|admin",
  "granted_by": "admin_user_id",
  "expires_at": "2025-12-31T23:59:59Z"
}
```

**GET /api/access-control/permissions** - List permissions
**GET /api/access-control/user/{user_id}/permissions** - User permissions
**DELETE /api/access-control/permissions/{permission_id}** - Revoke permission
**POST /api/access-control/roles** - Create role
**GET /api/access-control/roles** - List roles

---

## 4. LUá»’NG CÃ”NG VIá»†C IMPLEMENTATION

```mermaid
graph TD
    Start([ðŸš€ Start Implementation]) --> Env[ðŸ“¦ Setup Environment]
    
    Env --> EnvCheck{Environment OK?}
    EnvCheck -->|No| EnvFix[ðŸ”§ Fix Environment Issues]
    EnvFix --> Env
    EnvCheck -->|Yes| Core[ðŸ—ï¸ Build Core Infrastructure]
    
    Core --> Database[ðŸ—„ï¸ Setup Database Schema]
    Database --> DBTest{DB Connection OK?}
    DBTest -->|No| DBFix[ðŸ”§ Fix Database Issues]
    DBFix --> Database
    DBTest -->|Yes| Auth[ðŸ” Implement Authentication]
    
    Auth --> AuthTest{Auth Working?}
    AuthTest -->|No| AuthFix[ðŸ”§ Fix Auth Issues]
    AuthFix --> Auth
    AuthTest -->|Yes| BaseAPI[ðŸ“¡ Build Base API Structure]
    
    BaseAPI --> DocAPI[ðŸ“„ Implement Documents API]
    DocAPI --> DocTest{Doc API Tests Pass?}
    DocTest -->|No| DocFix[ðŸ”§ Fix Doc API Issues]
    DocFix --> DocAPI
    DocTest -->|Yes| UserAPI[ðŸ‘¤ Implement Users API]
    
    UserAPI --> UserTest{User API Tests Pass?}
    UserTest -->|No| UserFix[ðŸ”§ Fix User API Issues]  
    UserFix --> UserAPI
    UserTest -->|Yes| SearchAPI[ðŸ” Implement Search API]
    
    SearchAPI --> SearchTest{Search API Tests Pass?}
    SearchTest -->|No| SearchFix[ðŸ”§ Fix Search API Issues]
    SearchFix --> SearchAPI
    SearchTest -->|Yes| AccessAPI[ðŸ›¡ï¸ Implement Access Control API]
    
    AccessAPI --> AccessTest{Access API Tests Pass?}
    AccessTest -->|No| AccessFix[ðŸ”§ Fix Access API Issues]
    AccessFix --> AccessAPI
    AccessTest -->|Yes| Integration[ðŸ”— Integration Testing]
    
    Integration --> IntegTest{Integration Tests Pass?}
    IntegTest -->|No| IntegFix[ðŸ”§ Fix Integration Issues]
    IntegFix --> Integration
    IntegTest -->|Yes| Performance[âš¡ Performance Testing]
    
    Performance --> PerfTest{Performance Requirements Met?}
    PerfTest -->|No| PerfOptim[ðŸš€ Performance Optimization]
    PerfOptim --> Performance
    PerfTest -->|Yes| Security[ðŸ›¡ï¸ Security Testing]
    
    Security --> SecTest{Security Tests Pass?}
    SecTest -->|No| SecFix[ðŸ”’ Fix Security Issues]
    SecFix --> Security
    SecTest -->|Yes| Documentation[ðŸ“š Generate API Documentation]
    
    Documentation --> Deployment[ðŸš€ Deployment Preparation]
    Deployment --> Complete([âœ… Implementation Complete])
    
    %% Styling
    classDef startEnd fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    classDef process fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef fix fill:#ffebee,stroke:#c62828,stroke-width:2px
    
    class Start,Complete startEnd
    class Env,Core,Database,Auth,BaseAPI,DocAPI,UserAPI,SearchAPI,AccessAPI,Integration,Performance,Security,Documentation,Deployment process
    class EnvCheck,DBTest,AuthTest,DocTest,UserTest,SearchTest,AccessTest,IntegTest,PerfTest,SecTest decision
    class EnvFix,DBFix,AuthFix,DocFix,UserFix,SearchFix,AccessFix,IntegFix,PerfOptim,SecFix fix
```

---

## 5. IMPLEMENTATION STEPS CHI TIáº¾T

### 5.1 Phase 1: Core Infrastructure (Tuáº§n 1)

#### **Step 1.1: Database Schema Setup**
```sql
-- Create schema script (create_schema.sql)
-- Users table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    department VARCHAR(50) NOT NULL,
    role user_role NOT NULL DEFAULT 'employee',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Documents table  
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(500) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_path TEXT NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    department VARCHAR(50) NOT NULL,
    access_level access_level NOT NULL DEFAULT 'employee_only',
    author_id UUID REFERENCES users(id),
    description TEXT,
    tags TEXT[],
    version INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);  
CREATE INDEX idx_documents_department ON documents(department);
CREATE INDEX idx_documents_access_level ON documents(access_level);
CREATE INDEX idx_documents_tags ON documents USING GIN(tags);
```

#### **Step 1.2: Configuration Management**
```python
# app/core/config.py
from pydantic_settings import BaseSettings
from typing import List, Optional

class Settings(BaseSettings):
    # App Settings
    APP_NAME: str = "Knowledge Assistant API"
    APP_VERSION: str = "1.0.0"
    DEBUG: bool = False
    
    # Database
    DATABASE_URL: str = "postgresql://ka_user:ka_password_dev@localhost:5432/knowledge_assistant"
    DATABASE_ECHO: bool = False
    
    # Redis
    REDIS_URL: str = "redis://localhost:6379"
    
    # Elasticsearch
    ELASTICSEARCH_URL: str = "http://localhost:9200"
    
    # Security
    SECRET_KEY: str = "your-super-secret-key-change-in-production"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    REFRESH_TOKEN_EXPIRE_DAYS: int = 7
    
    # API Settings
    API_V1_PREFIX: str = "/api"
    CORS_ORIGINS: List[str] = ["http://localhost:3000", "http://localhost:8080"]
    
    # File Upload
    MAX_FILE_SIZE: int = 50 * 1024 * 1024  # 50MB
    ALLOWED_FILE_TYPES: List[str] = [".pdf", ".doc", ".docx", ".txt", ".md"]
    UPLOAD_DIR: str = "./uploads"
    
    # Vector DB
    CHROMA_PERSIST_DIR: str = "./chroma_db"
    
    class Config:
        env_file = ".env"

settings = Settings()
```

### 5.2 Phase 2: Authentication Layer (Tuáº§n 1)

#### **Step 2.1: JWT Authentication**
```python
# app/core/security.py
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
from jose import JWTError, jwt
from passlib.context import CryptContext
from pydantic import BaseModel

class Token(BaseModel):
    access_token: str
    refresh_token: str
    token_type: str = "bearer"

class TokenData(BaseModel):
    user_id: Optional[str] = None
    username: Optional[str] = None
    permissions: List[str] = []

class SecurityService:
    def __init__(self):
        self.pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
        self.secret_key = settings.SECRET_KEY
        self.algorithm = "HS256"
    
    def create_access_token(self, data: Dict[str, Any], expires_delta: Optional[timedelta] = None) -> str:
        to_encode = data.copy()
        if expires_delta:
            expire = datetime.utcnow() + expires_delta
        else:
            expire = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
        
        to_encode.update({"exp": expire})
        return jwt.encode(to_encode, self.secret_key, algorithm=self.algorithm)
    
    def verify_token(self, token: str) -> Optional[TokenData]:
        try:
            payload = jwt.decode(token, self.secret_key, algorithms=[self.algorithm])
            user_id: str = payload.get("sub")
            username: str = payload.get("username")
            permissions: List[str] = payload.get("permissions", [])
            
            if user_id is None or username is None:
                return None
                
            return TokenData(user_id=user_id, username=username, permissions=permissions)
        except JWTError:
            return None

security_service = SecurityService()
```

### 5.3 Phase 3: API Endpoints Implementation (Tuáº§n 2-3)

#### **Step 3.1: Documents API Implementation**
```python
# app/api/endpoints/documents.py
from fastapi import APIRouter, Depends, File, UploadFile, HTTPException, Query
from fastapi.responses import FileResponse
from typing import List, Optional
from uuid import UUID

from app.models.documents import Document, DocumentCreate, DocumentUpdate
from app.services.document_service import DocumentService
from app.api.dependencies import get_current_user, check_permissions

router = APIRouter(prefix="/documents", tags=["documents"])

@router.post("/", response_model=Document)
async def create_document(
    file: UploadFile = File(...),
    metadata: DocumentCreate = Depends(),
    current_user: User = Depends(get_current_user),
    document_service: DocumentService = Depends()
):
    """Upload and create a new document"""
    
    # Validate file
    if not file.filename.lower().endswith(tuple(settings.ALLOWED_FILE_TYPES)):
        raise HTTPException(400, "File type not allowed")
    
    if file.size > settings.MAX_FILE_SIZE:
        raise HTTPException(400, "File too large")
    
    # Check permissions
    if not await check_permissions(current_user, "write:documents"):
        raise HTTPException(403, "Insufficient permissions")
    
    # Process upload
    try:
        document = await document_service.create_document(
            file=file,
            metadata=metadata,
            author_id=current_user.id
        )
        return document
    except Exception as e:
        raise HTTPException(500, f"Failed to create document: {str(e)}")

@router.get("/", response_model=List[Document])
async def list_documents(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    department: Optional[str] = Query(None),
    access_level: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
    current_user: User = Depends(get_current_user),
    document_service: DocumentService = Depends()
):
    """List documents with filtering and pagination"""
    
    filters = {
        "department": department,
        "access_level": access_level, 
        "search": search,
        "user_permissions": current_user.permissions
    }
    
    documents = await document_service.list_documents(
        page=page,
        page_size=page_size,
        filters=filters,
        user_id=current_user.id
    )
    
    return documents

# Additional endpoints: GET /{id}, PUT /{id}, DELETE /{id}, GET /{id}/download
```

### 5.4 Phase 4: Testing Strategy (Tuáº§n 3)

#### **Step 4.1: Unit Tests**
```python
# tests/unit/test_documents_api.py
import pytest
from httpx import AsyncClient
from fastapi.testclient import TestClient

from app.main import app
from tests.conftest import test_user, test_document

class TestDocumentsAPI:
    
    @pytest.mark.asyncio
    async def test_create_document_success(self, async_client: AsyncClient, test_user):
        """Test successful document creation"""
        
        # Prepare test file
        test_file = {
            "file": ("test.pdf", b"fake pdf content", "application/pdf")
        }
        
        metadata = {
            "title": "Test Document",
            "department": "rd",
            "access_level": "employee_only",
            "description": "Test document description"
        }
        
        response = await async_client.post(
            "/api/documents/",
            files=test_file,
            data=metadata,
            headers={"Authorization": f"Bearer {test_user.access_token}"}
        )
        
        assert response.status_code == 201
        data = response.json()
        assert data["title"] == "Test Document"
        assert data["department"] == "rd"
    
    @pytest.mark.asyncio
    async def test_list_documents_with_pagination(self, async_client: AsyncClient, test_user):
        """Test document listing with pagination"""
        
        response = await async_client.get(
            "/api/documents/?page=1&page_size=10",
            headers={"Authorization": f"Bearer {test_user.access_token}"}
        )
        
        assert response.status_code == 200
        data = response.json()
        assert "data" in data
        assert "metadata" in data
        assert data["metadata"]["page"] == 1
        assert data["metadata"]["page_size"] == 10
```

#### **Step 4.2: Integration Tests**
```python
# tests/integration/test_api_integration.py
import pytest
from httpx import AsyncClient

class TestAPIIntegration:
    
    @pytest.mark.asyncio
    async def test_document_workflow(self, async_client: AsyncClient):
        """Test complete document workflow: create -> list -> get -> update -> delete"""
        
        # 1. Authenticate user
        auth_response = await async_client.post("/api/auth/login", json={
            "username": "testuser",
            "password": "testpassword"
        })
        token = auth_response.json()["access_token"]
        headers = {"Authorization": f"Bearer {token}"}
        
        # 2. Create document
        test_file = {"file": ("test.pdf", b"content", "application/pdf")}
        metadata = {"title": "Integration Test Doc", "department": "rd"}
        
        create_response = await async_client.post(
            "/api/documents/", 
            files=test_file, 
            data=metadata, 
            headers=headers
        )
        assert create_response.status_code == 201
        doc_id = create_response.json()["id"]
        
        # 3. List documents
        list_response = await async_client.get("/api/documents/", headers=headers)
        assert list_response.status_code == 200
        assert any(doc["id"] == doc_id for doc in list_response.json()["data"])
        
        # 4. Get specific document
        get_response = await async_client.get(f"/api/documents/{doc_id}", headers=headers)
        assert get_response.status_code == 200
        assert get_response.json()["title"] == "Integration Test Doc"
        
        # 5. Update document
        update_response = await async_client.put(
            f"/api/documents/{doc_id}",
            json={"title": "Updated Integration Test Doc"},
            headers=headers
        )
        assert update_response.status_code == 200
        
        # 6. Delete document
        delete_response = await async_client.delete(f"/api/documents/{doc_id}", headers=headers)
        assert delete_response.status_code == 204
```

---

## 6. ROLLBACK STRATEGIES & ERROR HANDLING

### 6.1 Rollback Points

```mermaid
graph TD
    Deploy[ðŸš€ Deployment] --> HealthCheck{Health Check Pass?}
    HealthCheck -->|No| Rollback1[ðŸ“¦ Rollback to Previous Version]
    HealthCheck -->|Yes| DBMigration[ðŸ—„ï¸ Database Migration]
    
    DBMigration --> DBCheck{Migration Success?}
    DBCheck -->|No| Rollback2[ðŸ”„ Rollback Database]
    DBCheck -->|Yes| APITest[ðŸ“¡ API Smoke Tests]
    
    APITest --> APICheck{API Tests Pass?}
    APICheck -->|No| Rollback3[âš¡ Rollback API Service]
    APICheck -->|Yes| LoadTest[âš–ï¸ Load Testing]
    
    LoadTest --> LoadCheck{Performance OK?}
    LoadCheck -->|No| Rollback4[ðŸš€ Scale Back/Optimize]
    LoadCheck -->|Yes| Success[âœ… Deployment Success]
    
    Rollback1 --> NotifyTeam[ðŸ“§ Notify Team]
    Rollback2 --> NotifyTeam
    Rollback3 --> NotifyTeam  
    Rollback4 --> NotifyTeam
    NotifyTeam --> Investigate
---
