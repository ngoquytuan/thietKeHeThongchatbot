Tá»•ng quan: báº£n review cá»§a báº¡n ráº¥t sáº¯câ€”mÃ¬nh Ä‘á»“ng Ã½ vá»›i cÃ¡c káº¿t luáº­n chÃ­nh (BM25 Ä‘ang â€œreadyâ€, Substring há»¯u Ã­ch cho exact/partial match, vÃ  Semantic cáº§n tá»‘i Æ°u hiá»‡u nÄƒng/gá»¡ trÃ¹ng). DÆ°á»›i Ä‘Ã¢y lÃ  pháº£n há»“i â€œgáº¯n codeâ€ + Ä‘á» xuáº¥t triá»ƒn khai cá»¥ thá»ƒ trong FR03.3.

# âœ… Äiá»ƒm báº¡n nÃªu & báº±ng chá»©ng trong codebase

* **Caching Ä‘Ã£ cÃ³ sáºµn Ä‘á»ƒ kÃ©o latency xuá»‘ng cho Semantic/Hybrid**
  Há»‡ thá»‘ng khá»Ÿi táº¡o `SearchOrchestrator` bá»c bá»Ÿi `CachedSearchOrchestrator` ngay khi app start, tá»©c lÃ  má»i search Ä‘á»u Ä‘i qua lá»›p cache (Redis) náº¿u báº­t Ä‘Æ°á»£c Redis. Xem startup: táº¡o `base_search_orchestrator = SearchOrchestrator()` rá»“i bá»c `CachedSearchOrchestrator` vÃ  `await â€¦ initialize()`  .
  TTL cá»§a cÃ¡c nhÃ³m dá»¯ liá»‡u (trong Ä‘Ã³ `search_results=300s`) Ä‘Æ°á»£c cáº¥u hÃ¬nh sáºµn á»Ÿ `RedisCacheManager.ttl_config`, cÃ³ sáºµn API Ä‘á»ƒ xem vÃ  cáº­p nháº­t TTL Ä‘á»™ng qua `/api/v1/cache/config` vÃ  `/api/v1/cache/config/ttl`   .

* **BM25 â€œproduction-readyâ€**
  Bá»™ test FR03.3A xÃ¡c nháº­n: 4/4 test suites pass, unaccent tiáº¿ng Viá»‡t 100%, search hoáº¡t Ä‘á»™ng Ä‘Ãºng vÃ  benchmark truy váº¥n Ä‘Æ¡n giáº£n <100ms (complex <200ms) â€” Ä‘Ã¢y lÃ  â€œÄ‘iá»ƒm tá»±aâ€ cho hybrid/prefilter báº¡n Ä‘á» xuáº¥t   .

* **Váº¥n Ä‘á» duplicate phÃ­a import Ä‘Ã£ Ä‘Æ°á»£c sá»­a tá»« gá»‘c**
  â€œFinal Import Summaryâ€ ghi rÃµ nguyÃªn nhÃ¢n do rule â€œtitle+departmentâ€ vÃ  Ä‘Ã£ **táº¯t** check nÃ y; giá»¯ láº¡i check â€œsource_document_idâ€ + â€œMD5 hashâ€ Ä‘á»ƒ nháº­n diá»‡n duplicate thá»±c sá»±. Äiá»u nÃ y khá»›p vá»›i tÃ¬nh huá»‘ng báº¡n tháº¥y 3 báº£n giá»‘ng nhau khÃ¡c ID váº«n Ä‘Æ°á»£c import (Ä‘Ãºng mong muá»‘n náº¿u lÃ  cÃ¡c phiÃªn báº£n khÃ¡c nhau)   .

# ğŸ¯ Khá»›p tá»«ng nháº­n xÃ©t cá»§a báº¡n â†’ viá»‡c lÃ m cá»¥ thá»ƒ

1. **Semantic Search quÃ¡ cháº­m (18.7s)**
   Ãp dá»¥ng 3 lá»›p tá»‘i Æ°uâ€”táº¥t cáº£ Ä‘á»u Ä‘Ã£ cÃ³ chá»— â€œmÃ³câ€ trong code:

   * **Báº­t cache káº¿t quáº£ & preload cÃ¡c truy váº¥n phá»• biáº¿n**:
     DÃ¹ng API `/api/v1/cache/preload` Ä‘á»ƒ náº¡p trÆ°á»›c popular queries theo phÃ²ng ban (Ä‘Ã£ cÃ³ sáºµn) â†’ giáº£m cold-start cho semantic collections lá»›n  .

   * **Giá»¯ model embed 1 láº§n duy nháº¥t (single instance)**:
     Sá»­ dá»¥ng `EmbeddingSingleton.get_instance()` Ä‘á»ƒ trÃ¡nh reload model má»—i request (Ä‘Ã£ cÃ³ sáºµn)  .

   * **Theo dÃµi vÃ  siáº¿t p95 latency**:
     Bá»™ checklist/monitoring gá»£i Ã½ Ä‘o baseline, thÃªm cáº£nh bÃ¡o `elapsed_time>3s` vÃ  log â€œhigh latencyâ€ â€” báº¡n cÃ³ thá»ƒ bÃª nguyÃªn khá»‘i vÃ o prod Ä‘á»ƒ canh chuáº©n <3s p95 trÆ°á»›c khi scale tiáº¿p  .

   > Bonus: Khi Ä‘Ã£ cÃ³ cache, báº¡n cÃ³ thá»ƒ Ä‘áº·t TTL `search_results` = 300-900s tÃ¹y lÆ°u lÆ°á»£ng (API update TTL Ä‘Ã£ cÃ³) Ä‘á»ƒ trade-off má»›i/cÅ© vs tá»‘c Ä‘á»™ .

2. **Duplicate trong káº¿t quáº£ Semantic**
   VÃ¬ import Ä‘Ã£ cho phÃ©p nhiá»u **version** cÃ¹ng title, hÃ£y **dedupe theo (document_id, chunk_id)** á»Ÿ táº§ng há»£p nháº¥t káº¿t quáº£. Báº¡n cÃ³ thá»ƒ thÃªm má»™t bÆ°á»›c `seen={(doc_id, chunk_id)}` trÆ°á»›c khi tráº£ `top_k` trong `HybridRanker.combine_results(...)` (file hiá»‡n Ä‘Ã£ cÃ³ merge & rerankâ€”chá»‰ cáº§n chen thÃªm bá»™ lá»c unique trÆ°á»›c sort/truncate). Pháº§n hybrid ranker hiá»‡n Ä‘ang há»£p Ä‘iá»ƒm semantic/keyword + diversity; bá»• sung filter unique lÃ  tháº³ng hÃ ng kiáº¿n trÃºc hiá»‡n táº¡i  *(file `hybrid_ranker.py` Ä‘Ã£ hiá»‡n diá»‡n trong repo; mÃ¬nh giá»¯ nguyÃªn Ä‘á» xuáº¥t á»Ÿ Ä‘Ã¢y Ä‘á»ƒ khÃ´ng lÃ m báº¡n quÃ¡ táº£i trÃ­ch dáº«n)*.

3. **Substring score & highlight**
   Ã tÆ°á»Ÿng tÃ­nh Ä‘iá»ƒm (frequency + first position + density) cá»§a báº¡n lÃ  há»£p lÃ½. NÆ¡i bÃ¡m nhanh nháº¥t hiá»‡n táº¡i lÃ  **Keyword/Substring layer** vÃ¬ `KeywordEngine` Ä‘ang tá»± tÃ­nh Ä‘iá»ƒm dá»±a trÃªn term count sau khi `col.get(... include=['documents'])` rá»“i match text cá»¥c bá»™. Báº¡n chá»‰ viá»‡c thay hÃ m cháº¥m Ä‘iá»ƒm hiá»‡n táº¡i báº±ng cÃ´ng thá»©c báº¡n Ä‘Æ°a ra vÃ  tráº£ thÃªm trÆ°á»ng `highlights` cho frontend (giá»¯ BM25/semantic nguyÃªn tráº¡ng). *(Äá»™ng cháº¡m nhá», khÃ´ng áº£nh hÆ°á»Ÿng DB)*

4. **Hybrid chiáº¿n lÆ°á»£c**

   * **BM25 pre-filter â†’ Semantic re-rank**: dÃ¹ng route `search_type="bm25"` trong orchestrator Ä‘á»ƒ láº¥y top-N candidate nhanh, sau Ä‘Ã³ gá»i semantic Ä‘á»ƒ tÃ­nh `similarity_score` vÃ  **RRF/weighted fusion**. Orchestrator Ä‘Ã£ tÃ¡ch `semantic/keyword/bm25/hybrid`, nÃªn chá»‰ cáº§n thÃªm má»™t nhÃ¡nh `hybrid_bm25_rerank` hoáº·c nÃ¢ng cáº¥p nhÃ¡nh `hybrid` hiá»‡n táº¡i thÃ nh â€œBM25 prefilter + semantic rerank + (optional) substring recallâ€.
   * **Quáº£n trá»‹ cache theo intent**: báº¡n cÃ³ `/cache/preload` Ä‘á»ƒ náº¡p trÆ°á»›c cÃ¡c truy váº¥n â€œHR nghá»‰ phÃ©p, quy trÃ¬nh, biá»ƒu máº«uâ€¦â€ theo phÃ²ng banâ€”ráº¥t há»£p vá»›i case thá»±c táº¿ (giáº£m cháº­m trá»… truy váº¥n â€œnÃ³ngâ€) .

# ğŸ› ï¸ Checklist thao tÃ¡c nhanh (Ä‘á» xuáº¥t triá»ƒn khai)

1. **Báº­t Redis + xÃ¡c nháº­n cache hoáº¡t Ä‘á»™ng**

   * Kiá»ƒm tra `/api/v1/cache/config` Ä‘á»ƒ xem tráº¡ng thÃ¡i káº¿t ná»‘i Redis + TTL hiá»‡n hÃ nh .
   * Äiá»u chá»‰nh TTL náº¿u cáº§n: `/api/v1/cache/config/ttl` (vÃ­ dá»¥, `{"search_results": 600}`) .

2. **Preload popular queries theo phÃ²ng ban**

   * Gá»i `/api/v1/cache/preload` vá»›i `{ "popular_queries": true, "departments": ["HR","General"] }` Ä‘á»ƒ sÆ°á»Ÿi áº¥m cache trÆ°á»›c giá» cao Ä‘iá»ƒm .

3. **ThÃªm dedupe á»Ÿ táº§ng há»£p nháº¥t káº¿t quáº£**

   * Lá»c trÃ¹ng theo `(document_id, chunk_id)` trÆ°á»›c khi cáº¯t `top_k` (Äƒn khá»›p vá»›i viá»‡c import cho phÃ©p multi-version, nhÆ° Ä‘Ã£ sá»­a trong Simple Import & Final Summary)  .

4. **NÃ¢ng cáº¥p Substring scoring + highlight**

   * Cáº¯m cÃ´ng thá»©c báº¡n Ä‘á» xuáº¥t vÃ o chá»— tÃ­nh Ä‘iá»ƒm text-match cá»§a keyword/substring; tráº£ thÃªm `highlights` (offsets) cho FE.

5. **Cháº¿ Ä‘á»™ Hybrid â€œBM25 â†’ Semantic rerankâ€**

   * Láº¥y `bm25` top-50, gá»i semantic Ä‘á»ƒ tÃ­nh similarity, há»£p nháº¥t báº±ng **RRF** (hoáº·c weight hiá»‡n táº¡i), rá»“i apply dedupe á»Ÿ bÆ°á»›c cuá»‘i.

# ğŸ“Œ Ghi chÃº thÃªm

* Náº¿u muá»‘n **benchmark sau tá»‘i Æ°u**, báº¡n cÃ³ sáºµn má»¥c â€œPerformance Benchmarksâ€ cá»§a BM25 Ä‘á»ƒ Ä‘á»‘i chiáº¿u nhanh (simple <100ms; complex <200ms). DÃ¹ng Ä‘Ã³ lÃ m baseline khi báº­t cache cho semantic/hybrid Ä‘á»ƒ xem tÃ¡c Ä‘á»™ng rÃµ rÃ ng .
* Bá»™ **checklist/monitoring** dÃ nh cho Chroma Ä‘Ã£ gá»£i Ã½ chá»‰ tiÃªu p95 <3s vÃ  cáº£nh bÃ¡o khi similarity tháº¥p/latency caoâ€”Ã¡p dá»¥ng tháº³ng lÃ  há»£p lÃ½ cho phase tá»‘i Æ°u tiáº¿p theo  .

---

Báº¡n muá»‘n mÃ¬nh viáº¿t ngay PR máº«u cho:
(a) bá»™ **dedupe (doc_id, chunk_id)** á»Ÿ Hybrid ranker,
(b) **substring scoring + highlight**, vÃ 
(c) **hybrid BM25â†’semantic rerank**
Ä‘á»ƒ báº¡n merge thá»­ trÃªn nhÃ¡nh staging khÃ´ng? MÃ¬nh cÃ³ thá»ƒ Ä‘áº©y kÃ¨m script warm-up cache Ä‘á»ƒ báº¡n cháº¡y sau khi deploy.

CÃ¢u há»i ráº¥t hay â€” vÃ  Ä‘Ãºng thá»i Ä‘iá»ƒm ğŸ‘

> **TÃ³m gá»n:**
> âŒ Báº¡n **khÃ´ng cáº§n thÃªm search engine nÃ o khÃ¡c**.
> âœ… NhÆ°ng báº¡n **nÃªn tinh chá»‰nh vÃ  káº¿t há»£p 3 engine hiá»‡n cÃ³** Ä‘á»ƒ Ä‘áº¡t hiá»‡u nÄƒng *production-grade*.

---

# âš™ï¸ **Hiá»‡n tráº¡ng FR03.3: ÄÃƒ Äá»¦ Bá»˜ 3 ENGINE CHUáº¨N Sáº¢N PHáº¨M**

| Má»¥c Ä‘Ã­ch                     | Engine                    | CÃ´ng nghá»‡                                       | Äiá»ƒm máº¡nh                   | Vai trÃ² trong FR03.3                     |
| ---------------------------- | ------------------------- | ----------------------------------------------- | --------------------------- | ---------------------------------------- |
| ğŸ” **Exact / Partial Match** | **Substring Search**      | PostgreSQL `ILIKE` hoáº·c Python substring engine | ChÃ­nh xÃ¡c 100%, Ä‘a ngÃ´n ngá»¯ | Cung cáº¥p káº¿t quáº£ â€œcháº¯c cháº¯nâ€             |
| ğŸ§  **Semantic Search**       | **ChromaDB + Embeddings** | Qwen / OpenAI / SentenceTransformer             | Hiá»ƒu ngá»¯ nghÄ©a, paraphrase  | TÃ¬m cÃ¢u há»i tÆ°Æ¡ng tá»±, tÃ i liá»‡u liÃªn quan |
| âš¡ **Keyword / Rank Search**  | **BM25 Search**           | PostgreSQL `tsvector` hoáº·c rank_bm25            | Nhanh, dá»… má»Ÿ rá»™ng           | LÃ  táº§ng â€œlá»c trÆ°á»›câ€ + ranking            |

â¡ï¸ **Ba engine nÃ y lÃ  Ä‘á»§ Ä‘á»ƒ bao phá»§ 100% use case thá»±c táº¿**:

* Exact / fuzzy match
* Context-aware semantic retrieval
* Lexical relevance ranking

---

# ğŸ§© **Khi nÃ o cáº§n THÃŠM engine khÃ¡c?**

Chá»‰ khi báº¡n muá»‘n **xá»­ lÃ½ nhá»¯ng tÃ¬nh huá»‘ng cá»±c chuyÃªn biá»‡t**, vÃ­ dá»¥:

| Use Case Ä‘áº·c biá»‡t                                                           | Engine cÃ³ thá»ƒ cÃ¢n nháº¯c                    | Ghi chÃº                                      |
| --------------------------------------------------------------------------- | ----------------------------------------- | -------------------------------------------- |
| ğŸ”Š TÃ¬m kiáº¿m báº±ng giá»ng nÃ³i hoáº·c Ã¢m thanh                                    | **ASR + Semantic rerank**                 | KhÃ´ng pháº£i core cá»§a FR03.3                   |
| ğŸ“¸ TÃ¬m kiáº¿m hÃ¬nh áº£nh hoáº·c PDF scan                                          | **Multimodal Embedding (CLIP, Florence)** | Chá»‰ cáº§n náº¿u báº¡n cÃ³ tÃ i liá»‡u hÃ¬nh áº£nh         |
| ğŸ§¬ TÃ¬m kiáº¿m ontology / tri thá»©c Ä‘á»‹nh danh                                   | **Knowledge Graph Search (Neo4j / RDF)**  | DÃ nh cho há»‡ thá»‘ng tri thá»©c phá»©c táº¡p          |
| ğŸ“… TÃ¬m kiáº¿m thá»i gian / sá»± kiá»‡n                                             | **Temporal Indexing**                     | CÃ³ thá»ƒ thÃªm module nhá», khÃ´ng cáº§n engine má»›i |
| ğŸ•µï¸â€â™‚ï¸ TÃ¬m kiáº¿m báº±ng ngÃ´n ngá»¯ tá»± nhiÃªn phá»©c táº¡p (LLM Retrieval-Augmented)** | **LLM Reranker / Hybrid RAG Layer**       | FR03.3 cÃ³ thá»ƒ má»Ÿ rá»™ng sang bÆ°á»›c nÃ y          |

> ğŸ‘‰ **FR03.3 hiá»‡n giá» náº±m á»Ÿ táº§ng â€œretrieval-coreâ€ hoÃ n chá»‰nh.**
> Náº¿u sau nÃ y báº¡n muá»‘n â€œRAGâ€ (Retrieval-Augmented Generation) vá»›i LLM, thÃ¬ chá»‰ cáº§n **thÃªm lá»›p reranker / generator**, **khÃ´ng cáº§n thÃªm engine.**

---

# ğŸ§  **HÆ°á»›ng Ä‘i tá»‘t nháº¥t bÃ¢y giá»**

Thay vÃ¬ thÃªm engine má»›i âœ hÃ£y **hoÃ n thiá»‡n 3 engine hiá»‡n cÃ³:**

### 1ï¸âƒ£ Semantic Optimization

* DÃ¹ng GPU hoáº·c FAISS index Ä‘á»ƒ giáº£m tá»« 18.7s â†’ < 1s
* ThÃªm cache táº§ng Redis (Ä‘Ã£ cÃ³ sáºµn háº¡ táº§ng)
* Chuáº©n hÃ³a duplicate & enrich metadata (language, doc_type)

### 2ï¸âƒ£ Substring Enhancement

* Ãp dá»¥ng cÃ´ng thá»©c báº¡n viáº¿t (frequency + density + position)
* ThÃªm highlight Ä‘á»ƒ frontend dá»… dÃ¹ng

### 3ï¸âƒ£ Hybrid Fusion

* TÃ­ch há»£p **RRF (Reciprocal Rank Fusion)**
* BM25 pre-filter â†’ Semantic rerank â†’ Merge Substring hits
* Má»i thá»© nÃ y cÃ³ thá»ƒ lÃ m trong `HybridRanker` hiá»‡n cÃ³

---

# ğŸš€ **Khi nÃ o nÃªn nghÄ© tá»›i bÆ°á»›c tiáº¿p theo (RAG Layer)?**

Khi báº¡n muá»‘n chatbot tráº£ lá»i dáº¡ng:

> â€œTheo quy Ä‘á»‹nh nghá»‰ phÃ©p á»Ÿ tÃ i liá»‡u HR_2024, nhÃ¢n viÃªn cáº§n gá»­i Ä‘Æ¡n trÆ°á»›c 3 ngÃ y.â€

Khi Ä‘Ã³, báº¡n **khÃ´ng cáº§n search engine má»›i**, mÃ  chá»‰ cáº§n:

```
Search engines (3 hiá»‡n táº¡i) â†’ 
Context Retriever (hybrid fusion) â†’ 
LLM (generator)
```

â†’ HÃ¬nh thÃ nh **RAG pipeline hoÃ n chá»‰nh.**

---

# âœ… **Káº¿t luáº­n cuá»‘i cÃ¹ng**

| Má»¥c tiÃªu                   | Tráº¡ng thÃ¡i                 | HÃ nh Ä‘á»™ng                             |
| -------------------------- | -------------------------- | ------------------------------------- |
| Search chÃ­nh xÃ¡c, nhanh    | âœ… Äá»§ vá»›i BM25 + Substring  | Duy trÃ¬                               |
| Search hiá»ƒu ngá»¯ nghÄ©a      | âœ… CÃ³ Semantic (cáº§n tá»‘i Æ°u) | Tá»‘i Æ°u tá»‘c Ä‘á»™                         |
| Search thÃ´ng minh há»£p nháº¥t | âš™ï¸ CÃ³ thá»ƒ tÃ­ch há»£p RRF     | Thá»±c hiá»‡n tuáº§n tá»›i                    |
| Chatbot hiá»ƒu tÃ i liá»‡u      | ğŸ”œ Cáº§n LLM RAG             | KhÃ´ng cáº§n thÃªm engine, chá»‰ thÃªm layer |

---

ğŸ‘‰ **TÃ³m láº¡i:**

> Báº¡n **Ä‘Ã£ Ä‘á»§ search engines máº¡nh.**
> Viá»‡c tiáº¿p theo lÃ  **tá»‘i Æ°u semantic, thÃªm hybrid fusion, vÃ  chuáº©n bá»‹ cho LLM RAG.**

---

Náº¿u báº¡n muá»‘n, tÃ´i cÃ³ thá»ƒ váº½ **sÆ¡ Ä‘á»“ tá»•ng thá»ƒ FR03.3 "Search Core + RAG Ready"** Ä‘á»ƒ báº¡n gá»­i cho dev team â€” bao gá»“m 3 engine, cache layer, vÃ  pipeline gá»£i Ã½ RAG. Báº¡n muá»‘n tÃ´i táº¡o sÆ¡ Ä‘á»“ Ä‘Ã³ khÃ´ng?

---

Ráº¥t hay! ÄÃ¢y chÃ­nh lÃ  **táº§ng â€œtrÃ­ tuá»‡ tri thá»©câ€ (Knowledge Layer)** â€” thá»© mÃ  háº§u háº¿t cÃ¡c há»‡ thá»‘ng search truyá»n thá»‘ng (nhÆ° BM25 hoáº·c Semantic Search) **khÃ´ng lÃ m Ä‘Æ°á»£c**, nhÆ°ng sáº½ **thay Ä‘á»•i háº³n tráº£i nghiá»‡m khi chatbot cáº§n â€œhiá»ƒu má»‘i quan há»‡ giá»¯a cÃ¡c khÃ¡i niá»‡mâ€**.

DÆ°á»›i Ä‘Ã¢y lÃ  giáº£i thÃ­ch chi tiáº¿t, liÃªn há»‡ trá»±c tiáº¿p vá»›i **FR03.3**.

---

## ğŸ§  1ï¸âƒ£ KhÃ¡i niá»‡m cÆ¡ báº£n

**Ontology Search / Knowledge Graph Search** lÃ  loáº¡i tÃ¬m kiáº¿m **khÃ´ng dá»±a vÃ o text Ä‘Æ¡n thuáº§n**, mÃ  dá»±a vÃ o **má»‘i quan há»‡ giá»¯a cÃ¡c thá»±c thá»ƒ (entities)** trong má»™t **Ä‘á»“ thá»‹ tri thá»©c (knowledge graph)**.

Thay vÃ¬ chá»‰ há»i â€œcá»¥m tá»« xuáº¥t hiá»‡n á»Ÿ Ä‘Ã¢uâ€, há»‡ thá»‘ng sáº½ hiá»ƒu:

> â€œNguyá»…n VÄƒn A lÃ  nhÃ¢n viÃªn cá»§a phÃ²ng HR, thuá»™c cÃ´ng ty X, tuÃ¢n theo chÃ­nh sÃ¡ch nghá»‰ phÃ©p Y.â€

NÃ³ cho phÃ©p **suy luáº­n logic (reasoning)** vÃ  **tÃ¬m kiáº¿m khÃ¡i niá»‡m liÃªn quan**, dÃ¹ trong text khÃ´ng cÃ³ cÃ¹ng tá»« khÃ³a.

---

## ğŸ§© 2ï¸âƒ£ Cáº¥u trÃºc tri thá»©c (Ontology / Knowledge Graph)

### ğŸ”¹ VÃ­ dá»¥ trá»±c quan

```plaintext
(Employee) Nguyá»…n VÄƒn A â”€â”€works_inâ”€â”€> (Department) HR
(Department) HR â”€â”€uses_policyâ”€â”€> (Document) HR_POLICY_2024
(Document) HR_POLICY_2024 â”€â”€definesâ”€â”€> (Concept) Nghá»‰ phÃ©p
```

â†’ Khi ngÆ°á»i dÃ¹ng há»i:

> â€œQuy Ä‘á»‹nh nghá»‰ phÃ©p cá»§a Nguyá»…n VÄƒn A lÃ  gÃ¬?â€

Há»‡ thá»‘ng **truy váº¥n qua quan há»‡:**

```
Employee â†’ Department â†’ Document â†’ Concept
```

vÃ  tráº£ lá»i: â€œTheo HR_POLICY_2024, nhÃ¢n viÃªn pháº£i xin phÃ©p trÆ°á»›c 3 ngÃ y.â€

---

## ğŸ§© 3ï¸âƒ£ CÃ¡ch triá»ƒn khai ká»¹ thuáº­t

### ğŸ•¸ï¸ **A. LÆ°u trá»¯ tri thá»©c**

* DÃ¹ng **graph database** nhÆ°:

  * **Neo4j** (phá»• biáº¿n nháº¥t)
  * **RDF triplestore** (Blazegraph, GraphDB, Stardog)
  * **Amazon Neptune**, **Azure Cosmos DB (Gremlin API)**

Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u dÆ°á»›i dáº¡ng **quan há»‡ 3 thÃ nh pháº§n (triples)**:

```
<subject> <predicate> <object>
```

VÃ­ dá»¥:

```
"Nguyá»…n VÄƒn A"  - works_in ->  "PhÃ²ng NhÃ¢n sá»±"
"PhÃ²ng NhÃ¢n sá»±" - uses_policy -> "HR_POLICY_2024"
"HR_POLICY_2024" - defines -> "Nghá»‰ phÃ©p"
```

---

### âš™ï¸ **B. Truy váº¥n**

* DÃ¹ng **Cypher (Neo4j)** hoáº·c **SPARQL (RDF)** Ä‘á»ƒ tÃ¬m má»‘i quan há»‡:

  ```cypher
  MATCH (e:Employee)-[:works_in]->(d:Department)-[:uses_policy]->(p:Document)
  WHERE e.name = "Nguyá»…n VÄƒn A"
  RETURN p.title
  ```

  Káº¿t quáº£: `"HR_POLICY_2024"`

* Truy váº¥n ngá»¯ nghÄ©a:

  ```sparql
  SELECT ?policy WHERE {
    ?emp rdf:type :Employee .
    ?emp :name "Nguyá»…n VÄƒn A" .
    ?emp :works_in ?dept .
    ?dept :uses_policy ?policy .
  }
  ```

---

## ğŸ§  4ï¸âƒ£ Káº¿t há»£p vá»›i FR03.3

FR03.3 hiá»‡n lÃ  **Text Search Platform**, nÃªn báº¡n cÃ³ thá»ƒ thÃªm **táº§ng tri thá»©c (Knowledge Layer)** mÃ  khÃ´ng cáº§n phÃ¡ vá»¡ cáº¥u trÃºc hiá»‡n táº¡i:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FR03.3 Core          â”‚
â”‚  â”œâ”€ Substring Engine         â”‚
â”‚  â”œâ”€ BM25 Engine              â”‚
â”‚  â”œâ”€ Semantic Engine          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    ğŸ§  Knowledge Graph Layer
             â”‚
             â–¼
      LLM / Chatbot Reasoner
```

---

### ğŸ”„ **TÃ­ch há»£p pipeline gá»£i Ã½**

1. **Tá»« dá»¯ liá»‡u text (document_chunks)**
   â†’ TrÃ­ch xuáº¥t entities vÃ  quan há»‡ (báº±ng NLP):

   ```python
   from openie import StanfordOpenIE
   triples = [
     ("Nguyá»…n VÄƒn A", "works_in", "HR"),
     ("HR", "uses_policy", "HR_POLICY_2024")
   ]
   ```
2. **Nháº­p cÃ¡c triple nÃ y vÃ o Neo4j:**

   ```python
   from neo4j import GraphDatabase
   driver = GraphDatabase.driver("bolt://localhost:7687", auth=("neo4j", "password"))

   with driver.session() as session:
       session.run("""
           MERGE (a:Employee {name:$a})
           MERGE (b:Department {name:$b})
           MERGE (a)-[:works_in]->(b)
       """, a="Nguyá»…n VÄƒn A", b="HR")
   ```
3. **LiÃªn káº¿t Knowledge Graph vá»›i Semantic Search:**

   * Khi user há»i, Semantic Search â†’ tÃ¬m Ä‘oáº¡n text chá»©a khÃ¡i niá»‡m.
   * Knowledge Graph â†’ tÃ¬m **má»‘i quan há»‡ vÃ  cÃ¡c thá»±c thá»ƒ liÃªn quan** Ä‘á»ƒ má»Ÿ rá»™ng cÃ¢u tráº£ lá»i.

---

## ğŸ’¬ 5ï¸âƒ£ Use Case thá»±c táº¿ trong doanh nghiá»‡p

| Use Case                               | Tri thá»©c cáº§n                     | VÃ­ dá»¥ cÃ¢u há»i                                                  |
| -------------------------------------- | -------------------------------- | -------------------------------------------------------------- |
| ğŸ” Truy xuáº¥t chÃ­nh sÃ¡ch theo nhÃ¢n viÃªn | NhÃ¢n viÃªn â€“ phÃ²ng ban â€“ tÃ i liá»‡u | â€œQuy Ä‘á»‹nh nghá»‰ phÃ©p cá»§a nhÃ¢n viÃªn IT lÃ  gÃ¬?â€                   |
| ğŸ§© Tra cá»©u phá»¥ thuá»™c giá»¯a vÄƒn báº£n      | VÄƒn báº£n â€“ Ä‘iá»u khoáº£n â€“ bá»™ luáº­t   | â€œÄiá»u khoáº£n nÃ o cá»§a Nghá»‹ Ä‘á»‹nh 12 liÃªn quan Ä‘áº¿n Luáº­t Lao Ä‘á»™ng?â€ |
| ğŸ¢ Tá»• chá»©c / Quáº£n trá»‹ tri thá»©c         | NgÆ°á»i â€“ chá»©c danh â€“ dá»± Ã¡n        | â€œAi phá»¥ trÃ¡ch dá»± Ã¡n ABC?â€                                      |
| ğŸ§  Chatbot logic reasoning             | KhÃ¡i niá»‡m â€“ Ä‘á»‹nh nghÄ©a â€“ quan há»‡ | â€œPhÃ©p cá»™ng vÃ  phÃ©p trá»« khÃ¡c gÃ¬ nhau trong quy Ä‘á»‹nh káº¿ toÃ¡n?â€   |

---

## ğŸš€ 6ï¸âƒ£ Lá»£i Ã­ch khi bá»• sung Knowledge Graph

| Lá»£i Ã­ch                         | MÃ´ táº£                                                                 |
| ------------------------------- | --------------------------------------------------------------------- |
| ğŸ§© **Hiá»ƒu má»‘i quan há»‡ dá»¯ liá»‡u** | KhÃ´ng chá»‰ â€œnÃ³i vá» gÃ¬â€, mÃ  â€œliÃªn quan Ä‘áº¿n ai / cÃ¡i gÃ¬ / vÄƒn báº£n nÃ oâ€   |
| ğŸ•µï¸â€â™‚ï¸ **Truy váº¥n Ä‘a bÆ°á»›c**     | CÃ³ thá»ƒ suy luáº­n nhiá»u lá»›p (â€œA thuá»™c B, B quy Ä‘á»‹nh C â‡’ A tuÃ¢n theo Câ€) |
| ğŸ§  **Káº¿t há»£p vá»›i LLM dá»… dÃ ng**  | LLM cÃ³ thá»ƒ dÃ¹ng graph Ä‘á»ƒ tráº£ lá»i logic (â€œtheo quan há»‡ nÃ y thÃ¬...â€)    |
| âš¡ **Cáº£i thiá»‡n search context**  | Semantic Search cÃ³ thá»ƒ Æ°u tiÃªn cÃ¡c chunks liÃªn quan trong graph       |
| ğŸ§° **Truy váº¿t nguá»“n dá»… dÃ ng**   | Má»—i káº¿t quáº£ cÃ³ thá»ƒ dáº«n Ä‘áº¿n node gá»‘c (tÃ i liá»‡u, ngÆ°á»i, quy Ä‘á»‹nh)       |

---

## âš–ï¸ 7ï¸âƒ£ Khi nÃ o **FR03.3 nÃªn cÃ³ Knowledge Graph**

| Má»©c Ä‘á»™ dá»¯ liá»‡u                                        | CÃ³ nÃªn thÃªm khÃ´ng?                                     |
| ----------------------------------------------------- | ------------------------------------------------------ |
| < 10,000 documents                                    | âŒ KhÃ´ng cáº§n â€“ Text search Ä‘á»§                           |
| 10,000 â€“ 100,000 docs, nhiá»u quan há»‡ chÃ©o             | âœ… Cáº§n xem xÃ©t                                          |
| > 100,000 docs, nhiá»u phÃ²ng ban vÃ  quy Ä‘á»‹nh liÃªn quan | ğŸš¨ Ráº¥t nÃªn â€“ GiÃºp kiá»ƒm tra logic vÃ  tÃ¬m theo khÃ¡i niá»‡m |

---

## ğŸ§­ 8ï¸âƒ£ Lá»™ trÃ¬nh Ä‘á» xuáº¥t náº¿u báº¡n muá»‘n thá»­

| Giai Ä‘oáº¡n                        | Má»¥c tiÃªu                                            | CÃ´ng cá»¥                             |
| -------------------------------- | --------------------------------------------------- | ----------------------------------- |
| **Phase 1:** TrÃ­ch xuáº¥t thá»±c thá»ƒ | Nháº­n diá»‡n `ngÆ°á»i`, `phÃ²ng ban`, `tÃ i liá»‡u`          | spaCy / underthesea / vncorenlp     |
| **Phase 2:** TrÃ­ch xuáº¥t quan há»‡  | `works_in`, `defines`, `uses_policy`, `approved_by` | OpenIE, fine-tune model             |
| **Phase 3:** XÃ¢y Knowledge Graph | Import triple vÃ o Neo4j                             | Neo4j, RDFLib                       |
| **Phase 4:** Káº¿t ná»‘i FR03.3      | Semantic search â†” Graph API                         | API layer hoáº·c reranker             |
| **Phase 5:** Truy váº¥n tá»± nhiÃªn   | SPARQL / Cypher + LLM                               | Natural language â†’ structured query |

---

## ğŸ“˜ Káº¿t luáº­n

| ÄÃ¡nh giÃ¡                                                                                                                      | Ná»™i dung |
| ----------------------------------------------------------------------------------------------------------------------------- | -------- |
| ğŸ§± Báº¡n **Ä‘Ã£ Ä‘á»§ search engines máº¡nh** cho text retrieval                                                                       |          |
| ğŸ§© **Knowledge Graph** lÃ  *táº§ng má»›i*, khÃ´ng thay tháº¿, mÃ  **bá»• sung kháº£ nÄƒng suy luáº­n logic**                                  |          |
| ğŸ”¥ Khi dá»¯ liá»‡u cá»§a báº¡n cÃ³ nhiá»u quan há»‡ (nhÃ¢n viÃªn â†” tÃ i liá»‡u â†” quy trÃ¬nh â†” quy Ä‘á»‹nh) â†’ **Ä‘Ã¢y lÃ  bÆ°á»›c tiáº¿n há»£p lÃ½ tiáº¿p theo** |          |

---

Náº¿u báº¡n muá»‘n, tÃ´i cÃ³ thá»ƒ giÃºp:

* Thiáº¿t káº¿ **â€œFR03.3 Ontology Extension Planâ€** â€” má»™t lá»™ trÃ¬nh 3 giai Ä‘oáº¡n Ä‘á»ƒ thÃªm Knowledge Graph vÃ o há»‡ thá»‘ng hiá»‡n táº¡i
  hoáº·c
* Táº¡o **máº«u schema Neo4j** cho â€œchÃ­nh sÃ¡ch cÃ´ng tyâ€ (HR_POLICY, Employee, Department, Document, Rule).

ğŸ‘‰ Báº¡n muá»‘n tÃ´i lÃ m cÃ¡i nÃ o trÆ°á»›c?

# FR03.3AR2 - BM25 Search System Handover Document

**Dá»± Ãn**: FR03.3AR2 - BM25 Vietnamese Text Search
**Database**: chatbotR3
**NgÃ y cáº­p nháº­t bÃ¡o cÃ¡o nÃ y**: 2025-10-18
**Tráº¡ng ThÃ¡i**: âœ… Production Ready
**Cap Nhat Gan Nhat**:

- 2025-10-17: Substring Search Engine fallback merged (xem `update_substring_17Oct.md`).
- 2025-10-09: Semantic Filter API endpoints & service shipped (xem `UPDATE_SUMMARY_9Oct.md`).

---

## ğŸ“‹ Má»¤C Lá»¤C

1. [Tá»•ng Quan Dá»± Ãn](#tá»•ng-quan-dá»±-Ã¡n)
2. [Cáº¥u TrÃºc Source Code](#cáº¥u-trÃºc-source-code)
3. [Module ChÃ­nh](#module-chÃ­nh)
4. [ThÆ° Viá»‡n & Dependencies](#thÆ°-viá»‡n--dependencies)
5. [Cáº¥u HÃ¬nh Há»‡ Thá»‘ng](#cáº¥u-hÃ¬nh-há»‡-thá»‘ng)
6. [Cháº¡y Thá»­ & Testing](#cháº¡y-thá»­--testing)
7. [LÆ°u Ã Quan Trá»ng](#lÆ°u-Ã½-quan-trá»ng)
8. [Troubleshooting](#troubleshooting)
9. [Cap Nhat 09-17 Oct 2025](#cap-nhat-09-17-oct-2025)

---

## Tá»”NG QUAN Dá»° ÃN

### Má»¥c ÄÃ­ch

XÃ¢y dá»±ng há»‡ thá»‘ng tÃ¬m kiáº¿m BM25 cho vÄƒn báº£n tiáº¿ng Viá»‡t vá»›i kháº£ nÄƒng:

- âœ… Bá» dáº¥u tiáº¿ng Viá»‡t (accent removal) cho tÃ¬m kiáº¿m linh hoáº¡t
- âœ… Index BM25 vá»›i PostgreSQL tsvector
- âœ… PhÃ¢n tÃ­ch vÄƒn báº£n tiáº¿ng Viá»‡t (word segmentation, POS tagging)
- âœ… Import 2-file format tá»« FR03.1 export
- âœ… PhÃ¡t hiá»‡n trÃ¹ng láº·p tÃ i liá»‡u
- âœ… Vector search vá»›i ChromaDB

### CÃ´ng Nghá»‡ Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Frontend / API Layer                 â”‚
â”‚                                              â”‚
â”‚  FastAPI (src/api/main.py)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Core Processing Layer                â”‚
â”‚                                              â”‚
â”‚  â€¢ Import Pipeline (simple_import_processor) â”‚
â”‚  â€¢ Vietnamese Analyzer                       â”‚
â”‚  â€¢ BM25 Indexer                             â”‚
â”‚  â€¢ Embedding Service (Qwen 1024-dim)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL     â”‚      ChromaDB            â”‚
â”‚   (chatbotR3)    â”‚   (Vector Search)        â”‚
â”‚                  â”‚                          â”‚
â”‚  â€¢ Documents     â”‚  â€¢ Embeddings            â”‚
â”‚  â€¢ Chunks        â”‚  â€¢ Collections           â”‚
â”‚  â€¢ BM25 Index    â”‚  â€¢ Metadata              â”‚
â”‚  â€¢ Vietnamese    â”‚                          â”‚
â”‚    Analysis      â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### TÃ­nh NÄƒng ÄÃ£ HoÃ n ThÃ nh

1. âœ… **Vietnamese Text Normalization**
   
   - Bá» dáº¥u: Ã¡â†’a, Ãªâ†’e, Ã´â†’o, Ä‘â†’d
   - Word segmentation vá»›i underthesea
   - POS tagging, NER

2. âœ… **BM25 Full-Text Search**
   
   - Index vá»›i PostgreSQL tsvector
   - Global terms tracking
   - IDF calculation
   - Collection statistics

3. âœ… **Import Pipeline**
   
   - 2-file format (document.json + passages.jsonl)
   - Duplicate detection
   - Batch processing
   - Error handling

4. âœ… **Data Quality**
   
   - 100% BM25 token coverage
   - 100% unaccenting
   - Foreign key integrity
   - Sequential positions

5. **Substring Search Engine (2025-10-17)**
   
   - Exact & partial substring fallback cho query ASCII / thuat ngu ky thuat
   - Yeu cau PostgreSQL `pg_trgm` + index `idx_chunk_content_trgm`

6. **Semantic Filter API (2025-10-09)**
   
   - Endpoint doc lap `/api/v1/search/semantic-filter` voi filters metadata ChromaDB
   - Dinh kem models, service, tests va tai lieu moi

---

## Cáº¤U TRÃšC SOURCE CODE

### ThÆ° Má»¥c ChÃ­nh

```
FR03.3_r3_3Oct/
â”œâ”€â”€ src/                          # Source code chÃ­nh
â”‚   â”œâ”€â”€ api/                      # FastAPI endpoints
â”‚   â”‚   â””â”€â”€ main.py              # API server
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                     # Core business logic
â”‚   â”‚   â”œâ”€â”€ analysis/            # Text analysis
â”‚   â”‚   â”‚   â””â”€â”€ vietnamese_text_analyzer.py  â­ QUAN TRá»ŒNG
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ pipeline/            # Import pipeline
â”‚   â”‚   â”‚   â””â”€â”€ simple_import_processor.py   â­ QUAN TRá»ŒNG
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ database/            # Database layer
â”‚   â”‚   â”‚   â””â”€â”€ v2_importer.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ embedding/           # Vector embeddings
â”‚   â”‚   â”‚   â””â”€â”€ embedding_service.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ search/              # Search engines
â”‚   â”‚   â”‚   â””â”€â”€ chromadb_connection.py
          substring_search_engine.py      # Exact/partial substring fallback (Oct 2025)
          semantic_filter_service.py      # Semantic filter core service (Oct 2025)
          semantic_engine_adapter.py      # Embedding adapter cho semantic filter (Oct 2025)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ vector/              # Vector DB
â”‚   â”‚   â”‚   â””â”€â”€ collection_manager.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ storage/             # File storage
â”‚   â”‚       â””â”€â”€ file_storage_manager.py
â”‚   â”‚
    models/                  # Pydantic models
       semantic_filter_models.py   # Semantic filter API models (Oct 2025)

â”‚   â””â”€â”€ utils/                   # Utilities
â”‚
â”œâ”€â”€ config/                      # Configuration
â”‚   â””â”€â”€ settings.py             # App settings
â”‚
â”œâ”€â”€ tests/                       # Test suite â­
â”‚   â”œâ”€â”€ test_01_database_connection.py
â”‚   â”œâ”€â”€ test_03_import_pipeline.py
â”‚   â”œâ”€â”€ test_04_bm25_normalization.py
â”‚   â”œâ”€â”€ test_05_bm25_search.py
â”‚   â””â”€â”€ test_06_data_integrity.py
    test_semantic_filter_api.py   # Semantic filter API integration (Oct 2025)
â”‚
 docs/                       # Documentation
    API_SEMANTIC_FILTER.md          # API reference (Oct 2025)
    QUICK_START_SEMANTIC_FILTER.md  # Quick start guide (Oct 2025)

â”œâ”€â”€ exports/                     # Import data folder
â”‚   â”œâ”€â”€ *_document.json         # Document metadata
â”‚   â””â”€â”€ *_passages.jsonl        # Chunk data
â”‚
â”œâ”€â”€ scripts/                     # Utility scripts
â”‚   â””â”€â”€ gpu_model_manager.py    # GPU model caching
â”‚
â”œâ”€â”€ models/                      # ML models cache
â”‚   â””â”€â”€ models--Qwen--Qwen3-Embedding-0.6B/
â”‚
â”œâ”€â”€ .env                         # Environment variables â­
â”œâ”€â”€ requirements.txt             # Python dependencies
â””â”€â”€ 01_schema_v13.sql           # Database schema â­
```

### File Quan Trá»ng Nháº¥t

#### 1. `src/core/analysis/vietnamese_text_analyzer.py` â­â­â­

**Chá»©c nÄƒng**: Xá»­ lÃ½ vÄƒn báº£n tiáº¿ng Viá»‡t

```python
class VietnameseTextAnalyzer:
    def remove_vietnamese_accents(text: str) -> str:
        """Bá» dáº¥u tiáº¿ng Viá»‡t"""
        # CÃ´ng ty â†’ Cong ty
        # NFD normalization + filter combining characters

    def normalize_for_search(text: str) -> str:
        """Chuáº©n hÃ³a cho BM25 search"""
        # 1. Bá» dáº¥u
        # 2. TÃ¡ch tá»« (word segmentation)
        # 3. Lowercase
        # 4. Bá» kÃ½ tá»± Ä‘áº·c biá»‡t

    def normalize_for_bm25(text: str, remove_stopwords: bool) -> str:
        """Chuáº©n hÃ³a cho BM25 vá»›i tÃ¹y chá»n bá» stopwords"""

    def analyze_text(text: str) -> VietnameseTextAnalysis:
        """PhÃ¢n tÃ­ch Ä‘áº§y Ä‘á»§: POS, NER, readability"""
```

**LÆ°u Ã½**:

- Sá»­ dá»¥ng `underthesea` cho word segmentation (nhanh nháº¥t)
- Fallback sang `pyvi` náº¿u underthesea lá»—i
- Unicode NFD normalization cho bá» dáº¥u
- Xá»­ lÃ½ Ä‘áº·c biá»‡t cho 'Ä/Ä‘' â†’ 'D/d'

#### 2. `src/core/pipeline/simple_import_processor.py` â­â­â­

**Chá»©c nÄƒng**: Import pipeline chÃ­nh

```python
class SimpleImportProcessor:
    async def import_from_directory(directory: Path):
        """Import táº¥t cáº£ file trong directory"""
        # 1. Scan for document/passages pairs
        # 2. Match files by prefix
        # 3. Import each pair

    async def import_file_pair(doc_file, passages_file):
        """Import 1 cáº·p file"""
        # 1. Load and validate JSON
        # 2. Import to database
        # 3. Generate BM25 tokens â­
        # 4. Update statistics â­
        # 5. Save Vietnamese analysis â­
        # 6. Import to ChromaDB

    async def _generate_bm25_tokens(document_id, chunks):
        """Generate BM25 tokens cho táº¥t cáº£ chunks"""
        # 1. Normalize Vietnamese text (bá» dáº¥u)
        # 2. Generate tsvector
        # 3. Extract terms vá»›i ts_stat
        # 4. Insert vÃ o document_bm25_index

    async def _update_bm25_statistics():
        """Update global BM25 statistics"""
        # 1. Update bm25_global_terms (IDF)
        # 2. Update bm25_collection_stats

    async def _save_vietnamese_analysis(document_id, chunks):
        """Analyze vÃ  save Vietnamese text"""
        # 1. Analyze tá»«ng chunk
        # 2. Save vÃ o vietnamese_text_analysis table
```

**LÆ°u Ã½**:

- **Quan trá»ng**: Pháº£i call Ä‘á»§ 3 methods: `_generate_bm25_tokens`, `_update_bm25_statistics`, `_save_vietnamese_analysis`
- Xá»­ lÃ½ lá»—i gracefully (continue on failure)
- Duplicate detection dá»±a trÃªn content hash
- Batch processing cho performance

#### 3. `01_schema_v13.sql` â­â­

**Database Schema** - Quan trá»ng cho hiá»ƒu cáº¥u trÃºc data

Tables chÃ­nh:

```sql
-- Documents
documents_metadata_v2              -- Metadata tÃ i liá»‡u
document_chunks_enhanced           -- Chunks + BM25 tokens
document_signatures               -- Duplicate detection

-- BM25 Index
document_bm25_index               -- Term index (bm25_id PK)
bm25_global_terms                 -- Global IDF (term_id PK)
bm25_collection_stats             -- Statistics (stats_id PK)

-- Vietnamese Analysis
vietnamese_text_analysis          -- POS, NER, metrics
```

**LÆ°u Ã½ Schema**:

- `document_bm25_index`: PK lÃ  `bm25_id` (NOT `index_id`)
- `bm25_collection_stats`: PK lÃ  `stats_id` (NOT `stat_id`)
- Column names: `total_unique_terms`, `total_term_occurrences`
- `vietnamese_text_analysis`: KhÃ´ng cÃ³ unique constraint trÃªn `document_id` (cho phÃ©p nhiá»u records)

## Táº¡o chá»‰ má»¥c Trigram (pg_trgm)** **trÃªn báº£ng Ä‘Ã£ cÃ³ dá»¯ liá»‡u**, mÃ  **khÃ´ng cáº§n xÃ³a hoáº·c náº¡p láº¡i** dá»¯ liá»‡u. PostgreSQL há»— trá»£ táº¡o chá»‰ má»¥c song song mÃ  khÃ´ng khÃ³a báº£ng lÃ¢u.

DÆ°á»›i Ä‘Ã¢y lÃ  hÆ°á»›ng dáº«n chi tiáº¿t vÃ  an toÃ n nháº¥t:

---

## âš™ï¸ 1. Kiá»ƒm tra extension `pg_trgm`

TrÆ°á»›c tiÃªn, Ä‘áº£m báº£o PostgreSQL cá»§a báº¡n cÃ³ module má»Ÿ rá»™ng `pg_trgm`
(chuyÃªn dÃ¹ng cho tÃ¬m kiáº¿m xáº¥p xá»‰ / substring match).

Cháº¡y lá»‡nh nÃ y trong **psql** hoáº·c **DBeaver / PgAdmin**:

```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
```

Náº¿u PostgreSQL tráº£ vá» `CREATE EXTENSION`, tá»©c lÃ  thÃ nh cÃ´ng âœ…
Náº¿u bÃ¡o lá»—i quyá»n (permission), hÃ£y cháº¡y báº±ng user `postgres`.

---

## âš™ï¸ 2. Táº¡o chá»‰ má»¥c Trigram cho cá»™t `chunk_content`

Báº£ng báº¡n Ä‘ang cÃ³:
`document_chunks_enhanced(chunk_content TEXT, document_id UUID, ...)`

HÃ£y cháº¡y:

```sql
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_chunk_content_trgm
ON document_chunks_enhanced
USING gin (chunk_content gin_trgm_ops);
```

### ğŸ’¡ Giáº£i thÃ­ch:

* `USING gin`: dÃ¹ng chá»‰ má»¥c GIN (Generalized Inverted Index)
* `gin_trgm_ops`: dÃ¹ng toÃ¡n tá»­ trigram Ä‘á»ƒ há»— trá»£ tÃ¬m kiáº¿m â€œgáº§n Ä‘Ãºngâ€ hoáº·c `ILIKE '%text%'`
* `CONCURRENTLY`: Ä‘á»ƒ trÃ¡nh **khÃ³a ghi (write lock)** khi báº£ng Ä‘ang dÃ¹ng

---

## âš™ï¸ 3. Kiá»ƒm tra chá»‰ má»¥c Ä‘Ã£ táº¡o thÃ nh cÃ´ng

Cháº¡y:

```sql
\di+ idx_chunk_content_trgm
```

Hoáº·c:

```sql
SELECT
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'document_chunks_enhanced';
```

Báº¡n sáº½ tháº¥y dÃ²ng nhÆ°:

```
idx_chunk_content_trgm | CREATE INDEX idx_chunk_content_trgm ON document_chunks_enhanced USING gin (chunk_content gin_trgm_ops)
```

---

## âš™ï¸ 4. Thá»­ nghiá»‡m tá»‘c Ä‘á»™ tÃ¬m kiáº¿m

So sÃ¡nh trÆ°á»›c/sau khi táº¡o index:

```sql
EXPLAIN ANALYZE
SELECT chunk_content
FROM document_chunks_enhanced
WHERE chunk_content ILIKE '%Approach Lighting System%';
```

Sau khi cÃ³ chá»‰ má»¥c trigram, báº¡n sáº½ tháº¥y PostgreSQL dÃ¹ng:

```
Bitmap Index Scan on idx_chunk_content_trgm ...
```

Thá»i gian giáº£m tá»« vÃ i giÃ¢y â†’ vÃ i chá»¥c mili-giÃ¢y âš¡

---

## âš™ï¸ 5. (Tuá»³ chá»n) Káº¿t há»£p similarity threshold

Báº¡n cÃ³ thá»ƒ kÃ­ch hoáº¡t tÃ¬m kiáº¿m â€œgáº§n Ä‘Ãºngâ€ hÆ¡n:

```sql
SET pg_trgm.similarity_threshold = 0.3;

SELECT chunk_content
FROM document_chunks_enhanced
WHERE chunk_content % 'Approch Lighting Systm';  -- sai chÃ­nh táº£ váº«n tÃ¬m Ä‘Æ°á»£c
```

ToÃ¡n tá»­ `%` dÃ¹ng fuzzy matching dá»±a trÃªn Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng trigram.

---

## âœ… TÃ³m táº¯t nhanh

| BÆ°á»›c | Lá»‡nh                                                                                                                                 |
| ---- | ------------------------------------------------------------------------------------------------------------------------------------ |
| 1    | `CREATE EXTENSION IF NOT EXISTS pg_trgm;`                                                                                            |
| 2    | `CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_chunk_content_trgm ON document_chunks_enhanced USING gin (chunk_content gin_trgm_ops);` |
| 3    | (TÃ¹y chá»n) `SET pg_trgm.similarity_threshold = 0.3;`                                                                                 |
| 4    | TÃ¬m báº±ng `ILIKE` hoáº·c `%`                                                                                                            |

---

---

#### 4. `src/core/search/substring_search_engine.py`  (New 17 Oct 2025)

**Chuc nang**: Fallback substring search (exact hoac partial) cho thuat ngu ky thuat va query ASCII.

```python
from src.core.search.substring_search_engine import SubstringSearchEngine

engine = SubstringSearchEngine()
results = await engine.search("ILS", top_k=5)
# Tra ve list[dict] voi document_id, chunk_id, content, substring_score
```

**Luu y**:

- Can PostgreSQL extension `pg_trgm` va index `idx_chunk_content_trgm` (xem muc Cau Hinh).
- Duoc SearchOrchestrator tu dong kich hoat khi semantic/BM25 rong hoac query toan ASCII.

#### 5. `src/core/search/semantic_filter_service.py`  (New 09 Oct 2025)

**Chuc nang**: Cung cap pure semantic search voi metadata filters cho cac endpoint `/api/v1/search/semantic-filter`.

```python
from src.core.search.semantic_filter_service import SemanticFilterService

service = SemanticFilterService()
response = await service.search(
    collection="kb_it_public",
    query="VPN",
    top_k=5,
    filters={"department_owner": "IT"},
    min_similarity=0.7
)
```

**Luu y**:

- Tai su dung GPU model manager qua `semantic_engine_adapter`.
- Tra ve similarity (0.0-1.0), execution_time_ms, metadata day du.
- Duoc bao phu boi tests: `tests/test_semantic_filter_api.py`.

#### 6. `src/models/semantic_filter_models.py`  (New 09 Oct 2025)

**Chuc nang**: Pydantic models cho request/response va health check cua semantic filter API.

**Classes chinh**:

- `SemanticFilterRequest`, `SemanticFilterResponse`
- `SearchResult`, `SearchResultMetadata`
- `SemanticFilterHealthResponse`

**Tham khao**: `UPDATE_SUMMARY_9Oct.md`, `docs/API_SEMANTIC_FILTER.md`.

## MODULE CHÃNH

### 1. Vietnamese Text Analysis Module

**Location**: `src/core/analysis/vietnamese_text_analyzer.py`

**Dependencies**:

- `underthesea`: Word segmentation, POS, NER
- `pyvi`: Backup cho Vietnamese processing
- `unicodedata`: NFD normalization

**Key Features**:

- âœ… Bá» dáº¥u (accent removal) - 100% working
- âœ… Word segmentation
- âœ… POS tagging
- âœ… Named Entity Recognition
- âœ… Readability scoring

**Usage**:

```python
from src.core.analysis.vietnamese_text_analyzer import VietnameseTextAnalyzer

analyzer = VietnameseTextAnalyzer()

# Bá» dáº¥u
text = "CÃ´ng ty TNHH Ká»¹ thuáº­t"
unaccented = analyzer.remove_vietnamese_accents(text)
# â†’ "Cong ty TNHH Ky thuat"

# Chuáº©n hÃ³a cho search
normalized = analyzer.normalize_for_search(text)
# â†’ "cong ty tnhh ky thuat"

# PhÃ¢n tÃ­ch Ä‘áº§y Ä‘á»§
analysis = await analyzer.analyze_text(text)
# â†’ VietnameseTextAnalysis object
```

### 2. Import Pipeline Module

**Location**: `src/core/pipeline/simple_import_processor.py`

**Dependencies**:

- `asyncpg`: Async PostgreSQL
- `vietnamese_text_analyzer`: Text processing
- `embedding_service`: Vector generation

**Key Features**:

- âœ… 2-file format support (document.json + passages.jsonl)
- âœ… Batch import from directory
- âœ… BM25 token generation
- âœ… Vietnamese text analysis
- âœ… Duplicate detection
- âœ… Error handling & rollback

**Usage**:

```python
from src.core.pipeline.simple_import_processor import SimpleImportProcessor

# Initialize
importer = SimpleImportProcessor()
await importer.initialize()

# Import tá»« directory
result = await importer.import_from_directory("exports/")

# Result format:
{
    "status": "completed",
    "files_found": 7,
    "imported": 4,
    "failed": 0,
    "results": [...]
}

# Cleanup
await importer.close()
```

### 3. BM25 Search Module

**Location**: Database functions in `01_schema_v13.sql`

**Key Functions**:

```sql
-- Search vá»›i BM25 ranking
SELECT chunk_content, ts_rank_cd(bm25_tokens, query) AS score
FROM document_chunks_enhanced,
     to_tsquery('simple', 'cong & ty') AS query
WHERE bm25_tokens @@ query
ORDER BY score DESC;

-- Update collection stats
SELECT update_bm25_collection_stats();

-- Calculate IDF
SELECT calculate_idf('term_value');
```

**Usage tá»« Python**:

```python
# Simple search
results = await conn.fetch("""
    SELECT chunk_content, ts_rank_cd(bm25_tokens, query) AS score
    FROM document_chunks_enhanced,
         to_tsquery('simple', $1) AS query
    WHERE bm25_tokens @@ query
    ORDER BY score DESC
    LIMIT 10
""", "cong & ty")
```

### 4. Embedding Service Module

**Location**: `src/core/embedding/embedding_service.py`

**Model**: Qwen/Qwen3-Embedding-0.6B (1024 dimensions)

**Key Features**:

- âœ… GPU acceleration (CUDA)
- âœ… Batch processing
- âœ… Model caching
- âœ… Automatic device selection

**Usage**:

```python
from src.core.embedding.embedding_service import EmbeddingService

service = EmbeddingService()
await service.initialize()

# Generate embeddings
texts = ["CÃ´ng ty ABC", "Quy trÃ¬nh tuyá»ƒn dá»¥ng"]
embeddings = await service.generate_embeddings(texts)
# â†’ numpy array shape (2, 1024)
```

### 5. ChromaDB Collection Manager

**Location**: `src/core/vector/collection_manager.py`

**Key Features**:

- âœ… Collection normalization
- âœ… Auto-create collections
- âœ… Fallback handling

**Usage**:

```python
from src.core.vector.collection_manager import CollectionManager

manager = CollectionManager()

# Get or create collection
collection = manager.create_collection_if_not_exists(
    "hr_documents",
    metadata={"description": "HR policies"}
)

# List collections
collections = manager.list_collections()
```

### 6. Substring Search Engine (Oct 2025)

**Location**: `src/core/search/substring_search_engine.py`

**Nhiem vu**:

- Fallback substring search cho query ASCII/ky hieu ky thuat.
- Ho tro exact match `%query%` va fuzzy match (tuong thich pg_trgm).
- Log ket qua: `SubstringSearchEngine found X matches for 'query'`.

**Usage**:

```python
from src.core.search.substring_search_engine import SubstringSearchEngine

engine = SubstringSearchEngine()
results = await engine.search("Approach Lighting System", top_k=5)
```

**Tich hop Orchestrator**:

- Import trong `src/core/search/search_orchestrator.py`.
- Kich hoat neu semantic va BM25 deu rong hoac query toan ASCII.
- Tra ve payload `search_type="substring"` voi danh sach chunk day du.

**Database can chuan bi**:

```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX IF NOT EXISTS idx_chunk_content_trgm
ON document_chunks_enhanced
USING gin (chunk_content gin_trgm_ops);
```

### 7. Semantic Filter Service (Oct 2025)

**Location**: `src/core/search/semantic_filter_service.py`

**Endpoints lien quan**:

- `GET /api/v1/search/semantic-filter/health`
- `GET /api/v1/search/semantic-filter/collections`
- `POST /api/v1/search/semantic-filter`

**Key Features**:

- Pure semantic search truc tiep toi ChromaDB (khong qua SearchOrchestrator).
- Metadata filters voi `$and`, `$or`, `$in`, `$nin`, `$contains`, so sanh `$gt/$lt`.
- Tham so `min_similarity`, thong ke `execution_time_ms`, `total_results`.
- Su dung `semantic_engine_adapter` de chia se GPU model manager.

**Tests & Tai lieu**:

- Pytest: `tests/test_semantic_filter_api.py` (10+ case).
- Tai lieu: `QUICK_START_SEMANTIC_FILTER.md`, `docs/API_SEMANTIC_FILTER.md`, `IMPLEMENTATION_COMPLETE.md`.
- Tong ket: `UPDATE_SUMMARY_9Oct.md`.

**Usage mau**:

```python
from src.models.semantic_filter_models import SemanticFilterRequest
from src.core.search.semantic_filter_service import SemanticFilterService

service = SemanticFilterService()
req = SemanticFilterRequest(collection="kb_it_public", query="MikroTik", top_k=5)
result = await service.search(**req.model_dump())
```

---

## THÆ¯ VIá»†N & DEPENDENCIES

### Core Dependencies (requirements.txt)

```txt
# Database
asyncpg==0.29.0              # PostgreSQL async driver
psycopg2-binary==2.9.9       # PostgreSQL sync driver

# Vietnamese NLP
underthesea==6.8.0           # â­ Word segmentation (primary)
pyvi==0.1.1                  # â­ Backup Vietnamese processing

# Machine Learning
sentence-transformers==2.2.2  # â­ Qwen embeddings
torch==2.0.1                 # PyTorch for GPU
transformers==4.35.2         # HuggingFace models

# Vector Database
chromadb==0.4.18             # Vector search

# Web Framework
fastapi==0.104.1             # API server
uvicorn==0.24.0              # ASGI server

# Utilities
loguru==0.7.2                # Logging
python-dotenv==1.0.0         # Environment variables
pydantic==2.5.0              # Data validation

# Testing
pytest==7.4.3                # Test framework
pytest-asyncio==0.21.1       # Async testing
```

### CÃ i Äáº·t Dependencies

```bash
# Method 1: pip install tá»« requirements.txt
pip install -r requirements.txt

# Method 2: CÃ i tá»«ng package quan trá»ng
pip install asyncpg psycopg2-binary
pip install underthesea pyvi
pip install sentence-transformers torch
pip install chromadb
pip install fastapi uvicorn
pip install pytest pytest-asyncio
pip install loguru python-dotenv
```

### GPU Requirements (Optional nhÆ°ng khuyáº¿n nghá»‹)

- NVIDIA GPU vá»›i CUDA support
- CUDA Toolkit 11.8+
- cuDNN 8.x
- 4GB+ VRAM

**Náº¿u khÃ´ng cÃ³ GPU**: Há»‡ thá»‘ng tá»± Ä‘á»™ng fallback vá» CPU (cháº­m hÆ¡n)

---

## Cáº¤U HÃŒNH Há»† THá»NG

### 1. Environment Variables (.env)

```bash
# Database Configuration
POSTGRES_HOST=192.168.1.95
POSTGRES_PORT=5432
POSTGRES_DB=chatbotR3          # â­ Database name
POSTGRES_USER=kb_admin
POSTGRES_PASSWORD=1234567890

DATABASE_URL=postgresql://kb_admin:1234567890@192.168.1.95:5432/chatbotR3
ASYNC_DATABASE_URL=postgresql://kb_admin:1234567890@192.168.1.95:5432/chatbotR3

# ChromaDB Configuration
CHROMA_HOST=192.168.1.95
CHROMA_PORT=8001

# Model Configuration
EMBEDDING_MODEL=Qwen/Qwen3-Embedding-0.6B  # â­ 1024-dim model
EMBEDDING_DIMENSION=1024
EMBEDDING_DEVICE=cuda          # cuda hoáº·c cpu
EMBEDDING_BATCH_SIZE=16

# Feature Flags
ENABLE_SEMANTIC_FILTERS_ENDPOINT=true  # Bat endpoint semantic filter (Oct 2025)

# Storage
STORAGE_PATH=/opt/chatbot-storage
```

### 2. Settings (config/settings.py)

```python
class Settings(BaseSettings):
    # Database
    POSTGRES_HOST: str = "192.168.1.95"
    POSTGRES_PORT: int = 5432
    POSTGRES_DB: str = "chatbotR3"      # â­
    POSTGRES_USER: str = "kb_admin"

    # Model
    EMBEDDING_MODEL: str = "Qwen/Qwen3-Embedding-0.6B"
    EMBEDDING_DIMENSION: int = 1024

    # Paths
    MODELS_DIR: Path = Path("./models")  # â­ Model cache

    class Config:
        env_file = ".env"
```

### 3. Database Setup

```bash
# Táº¡o database (náº¿u chÆ°a cÃ³)
psql -h 192.168.1.95 -U kb_admin -c "CREATE DATABASE chatbotR3"

# Apply schema
psql -h 192.168.1.95 -U kb_admin -d chatbotR3 -f 01_schema_v13.sql

# Verify
psql -h 192.168.1.95 -U kb_admin -d chatbotR3 -c "\dt"
```

### 4. Model Cache Setup

```bash
# Model sáº½ tá»± Ä‘á»™ng download vÃ o ./models/
# Láº§n Ä‘áº§u cháº¡y sáº½ máº¥t 5-10 phÃºt

# Location:
# ./models/models--Qwen--Qwen3-Embedding-0.6B/

# Size: ~2.5GB
```

### 5. Substring Search Engine Indexes (Oct 2025)

```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX IF NOT EXISTS idx_chunk_content_trgm
ON document_chunks_enhanced
USING gin (chunk_content gin_trgm_ops);
```

**Chay 1 lan** tren database `chatbotR3` truoc khi bat substring fallback.
**Fuzzy mode**: su dung `similarity(chunk_content, :query) > 0.25` (xem `update_substring_17Oct.md`).

---

## CHáº Y THá»¬ & TESTING

### Quick Start - Cháº¡y Thá»­ Ngay (30 giÃ¢y)

```bash
cd D:\Projects\checkbot\docker\test\FR03.3_r3_3Oct

# 1. Kiá»ƒm tra há»‡ thá»‘ng
python quick_smoke_test.py

# Expected output:
# [OK] Database connected
# [OK] All 5 BM25 tables exist
# [OK] Found X documents, Y chunks
# [OK] All chunks have BM25 tokens (100%)
# [OK] All terms properly unaccented
# [OK] BM25 search working
# SUCCESS: ALL SMOKE TESTS PASSED!
```

### Import Test - Test Import Dá»¯ Liá»‡u

```bash
# Check hiá»‡n táº¡i cÃ³ gÃ¬
python check_bm25_stats.py

# Import táº¥t cáº£ file tá»« exports/
python import_new_exports.py

# Verify import thÃ nh cÃ´ng
python quick_smoke_test.py
```

### Full Test Suite - Test ToÃ n Bá»™

```bash
# Cháº¡y táº¥t cáº£ tests
python run_all_tests.py

# Hoáº·c dÃ¹ng pytest
pytest tests/ -v

# Cháº¡y tá»«ng test suite
pytest tests/test_01_database_connection.py -v
pytest tests/test_04_bm25_normalization.py -v
pytest tests/test_05_bm25_search.py -v
pytest tests/test_06_data_integrity.py -v
pytest tests/test_semantic_filter_api.py -v
```

### Test Cases ChÃ­nh

#### Test 1: Database Connection

```bash
pytest tests/test_01_database_connection.py -v

# Tests:
# âœ… Database connectivity
# âœ… Schema tables exist
# âœ… Unaccent extension
# âœ… Table structures correct
```

#### Test 2: Vietnamese Normalization

```bash
pytest tests/test_04_bm25_normalization.py -v

# Tests:
# âœ… Accent removal (12 test cases)
# âœ… Sentence normalization
# âœ… BM25 tokens unaccented
# âœ… Index unaccented
# âœ… Searchable
```

#### Test 3: BM25 Search

```bash
pytest tests/test_05_bm25_search.py -v

# Tests:
# âœ… Basic search
# âœ… Ranking order
# âœ… Multi-word queries
# âœ… Accent-insensitive
# âœ… Collection stats
```

#### Test 4: Data Integrity

```bash
pytest tests/test_06_data_integrity.py -v

# Tests:
# âœ… Foreign keys
# âœ… Sequential positions
# âœ… No duplicates
# âœ… Token coverage
# âœ… Stats consistency
```

#### Test 5: Import Pipeline

```bash
pytest tests/test_03_import_pipeline.py -v -s

# Tests:
# âœ… File validation
# âœ… Full import
# âœ… Metadata insertion
# âœ… Chunks imported
# âœ… BM25 tokens generated
# âœ… Vietnamese analysis saved
# âœ… Duplicate detection
```

#### Test 6: Semantic Filter API (Oct 2025)

```bash
pytest tests/test_semantic_filter_api.py -v -s

# Tests:
#  Health + collections endpoints
#  Pure semantic search voi filters
#  Min similarity threshold
#  Validation & error handling
#  Response structure (metadata, scores)
```

#### Test 7: Substring Search Fallback (Oct 2025)

```bash
# 1. Khoi dong API server (uvicorn src.api.main:app --reload)
curl -X POST http://localhost:8000/api/v1/search/substring \
  -H "Content-Type: application/json" \
  -d '{"query": "ILS", "top_k": 5}'

# Hoac dung hybrid:
curl -X POST http://localhost:8000/api/v1/search/hybrid \
  -H "Content-Type: application/json" \
  -d '{"query": "Approach Lighting System", "top_k": 5, "search_type": "hybrid"}'
```

**Expected**: `search_type` = `substring`, co it nhat 1 ket qua voi `substring_score=1.0` va chunk tu PostgreSQL.

### Manual Testing - Test Tá»«ng Chá»©c NÄƒng

```bash
# Test accent removal
python test_accent_removal.py

# Test BM25 search
python test_bm25_search.py

# Test unaccented terms
python check_unaccented_terms.py

# Interactive import
python test_import_manual.py
```

### Performance Testing

```bash
# Äo thá»i gian import
powershell "Measure-Command { python import_new_exports.py }"

# Expected: 5-7 giÃ¢y per document (7 chunks)
```

---

## LÆ¯U Ã QUAN TRá»ŒNG

### âš ï¸ Äiá»u Tuyá»‡t Äá»‘i KHÃ”NG ÄÆ¯á»¢C LÃ€M

1. **KHÃ”NG thay Ä‘á»•i schema tables** mÃ  khÃ´ng test ká»¹
   
   - Tables: `document_bm25_index`, `bm25_collection_stats`
   - ÄÃ£ fix column names: `bm25_id`, `stats_id`, `total_unique_terms`

2. **KHÃ”NG skip cÃ¡c bÆ°á»›c BM25 generation**
   
   - Pháº£i call: `_generate_bm25_tokens()`
   - Pháº£i call: `_update_bm25_statistics()`
   - Pháº£i call: `_save_vietnamese_analysis()`

3. **KHÃ”NG xÃ³a Vietnamese analyzer code**
   
   - Method `remove_vietnamese_accents()` - QUAN TRá»ŒNG
   - Method `normalize_for_search()` - QUAN TRá»ŒNG

4. **KHÃ”NG thay Ä‘á»•i model**
   
   - Äang dÃ¹ng: `Qwen/Qwen3-Embedding-0.6B` (1024-dim)
   - Models khÃ¡c sáº½ khÃ´ng tÆ°Æ¡ng thÃ­ch vá»›i existing embeddings

5. **KHÃ”NG hard-code database name**
   
   - DÃ¹ng config: `settings.POSTGRES_DB`
   - Äá»«ng viáº¿t: `database='chatbotR3'` trong code

### âœ… Best Practices

1. **LuÃ´n test sau khi sá»­a code**
   
   ```bash
   python quick_smoke_test.py
   pytest tests/ -v
   ```

2. **Backup database trÆ°á»›c khi clean**
   
   ```bash
   # Export data
   pg_dump -h 192.168.1.95 -U kb_admin chatbotR3 > backup.sql
   ```

3. **Check logs khi import fail**
   
   ```bash
   # Logs trong file hoáº·c console
   grep "ERROR" import_output.log
   ```

4. **Verify BM25 coverage thÆ°á»ng xuyÃªn**
   
   ```bash
   python check_bm25_stats.py
   ```

5. **Monitor unaccenting quality**
   
   ```bash
   python check_unaccented_terms.py
   # Should show: 0 accented terms
   ```

### ğŸ”§ Configuration Tips

1. **GPU Memory**
   
   - Máº·c Ä‘á»‹nh: `EMBEDDING_BATCH_SIZE=16`
   - Náº¿u out of memory: giáº£m xuá»‘ng 8 hoáº·c 4
   - Náº¿u cÃ³ nhiá»u RAM: tÄƒng lÃªn 32

2. **Import Performance**
   
   - Vietnamese analysis lÃ  pháº§n cháº­m nháº¥t (~500ms/chunk)
   - KhÃ´ng thá»ƒ parallel vÃ¬ database transactions
   - CÃ³ thá»ƒ disable ChromaDB import Ä‘á»ƒ nhanh hÆ¡n

3. **Search Performance**
   
   - BM25 index cÃ³ khoáº£ng 3,000 entries cho 4 docs
   - Query time < 100ms cho simple queries
   - Náº¿u cháº­m: check index trÃªn `bm25_tokens` column

### ğŸ› Common Issues & Fixes

#### Issue 1: "ModuleNotFoundError: underthesea"

```bash
pip install underthesea pyvi
```

#### Issue 2: "Cannot connect to database"

```bash
# Check connection
psql -h 192.168.1.95 -U kb_admin -d chatbotR3 -c "SELECT 1"

# Check .env file cÃ³ Ä‘Ãºng credentials
```

#### Issue 3: "Column 'index_id' does not exist"

```bash
# Schema Ä‘Ã£ fix, column name lÃ  'bm25_id'
# Update code náº¿u cÃ²n dÃ¹ng 'index_id'
grep -r "index_id" src/
```

#### Issue 4: "BM25 tokens not generated"

```bash
# Check method Ä‘Æ°á»£c call
grep "_generate_bm25_tokens" src/core/pipeline/simple_import_processor.py

# Re-import
python clean_database.py
python import_new_exports.py
```

#### Issue 5: "Accented terms in index"

```bash
# Check Vietnamese analyzer
python test_accent_removal.py

# Should output: "cong ty" not "cÃ´ng ty"

# Re-import náº¿u cáº§n
python clean_database.py
python import_new_exports.py
```

---

## TROUBLESHOOTING

### Debug Mode

Enable debug logging:

```python
# Trong code
from loguru import logger
logger.add("debug.log", level="DEBUG")

# Hoáº·c set env
export LOG_LEVEL=DEBUG
```

### Database Queries for Debugging

```sql
-- Check documents
SELECT COUNT(*) FROM documents_metadata_v2;

-- Check chunks cÃ³ tokens
SELECT COUNT(*) FROM document_chunks_enhanced WHERE bm25_tokens IS NOT NULL;

-- Check accented terms (should be 0)
SELECT COUNT(*) FROM document_bm25_index
WHERE term ~ '[Ã¡Ã áº£Ã£áº¡áº¯áº±áº³áºµáº·áº¥áº§áº©áº«áº­Ã©Ã¨áº»áº½áº¹áº¿á»á»ƒá»…á»‡Ã­Ã¬á»‰Ä©á»‹Ã³Ã²á»Ãµá»á»‘á»“á»•á»—á»™á»›á»á»Ÿá»¡á»£ÃºÃ¹á»§Å©á»¥á»©á»«á»­á»¯á»±Ã½á»³á»·á»¹á»µÄ‘]';

-- Top terms
SELECT term, SUM(term_frequency) as freq
FROM document_bm25_index
GROUP BY term
ORDER BY freq DESC
LIMIT 20;

-- Check Vietnamese analysis coverage
SELECT
    (SELECT COUNT(*) FROM vietnamese_text_analysis) as analyses,
    (SELECT COUNT(*) FROM document_chunks_enhanced) as chunks;
-- Should be equal
```

### Performance Profiling

```python
# Time import
import time
start = time.time()
await importer.import_from_directory("exports/")
print(f"Import took: {time.time() - start:.2f}s")

# Memory usage
import psutil
process = psutil.Process()
print(f"Memory: {process.memory_info().rss / 1024 / 1024:.2f} MB")
```

---

## TÃ€I LIá»†U THAM KHáº¢O

### Documentation Files

1. **HOW_TO_TEST_IMPORT.md** - HÆ°á»›ng dáº«n test import (â­ Báº®T Äáº¦U ÄÃ‚Y)
2. **IMPORT_TESTING_GUIDE.md** - Chi tiáº¿t vá» import testing
3. **IMPORT_TEST_REPORT.md** - Káº¿t quáº£ test má»›i nháº¥t
4. **VIETNAMESE_UNACCENT_IMPLEMENTATION.md** - Chi tiáº¿t vá» bá» dáº¥u
5. **BM25_IMPLEMENTATION_STATUS.md** - Tráº¡ng thÃ¡i BM25
6. **FR03.3A_TEST_RESULTS.md** - Káº¿t quáº£ test Ä‘áº§y Ä‘á»§
7. **tests/README.md** - HÆ°á»›ng dáº«n test suite
8. **NEW_EXPORT_FORMAT.md** - Format file export
9. **UPDATE_SUMMARY_9Oct.md** - Tong ket release semantic filter
10. **QUICK_START_SEMANTIC_FILTER.md** - Huong dan 5 phut cho API semantic filter
11. **docs/API_SEMANTIC_FILTER.md** - Tai lieu API day du + filter syntax
12. **update_substring_17Oct.md** - Huong dan tich hop Substring Search Engine
13. **IMPLEMENTATION_COMPLETE.md** - Trang thai hoan thanh semantic filter service

### External Resources

- **underthesea docs**: https://github.com/undertheseanlp/underthesea
- **PostgreSQL tsvector**: https://www.postgresql.org/docs/current/datatype-textsearch.html
- **ChromaDB**: https://docs.trychroma.com/
- **Qwen Embeddings**: https://huggingface.co/Qwen/Qwen3-Embedding-0.6B

---

## DEPLOYMENT CHECKLIST

### Pre-Deployment

- [ ] Cháº¡y full test suite: `python run_all_tests.py`
- [ ] Verify all tests pass
- [ ] Check BM25 coverage: `python check_bm25_stats.py`
- [ ] Verify unaccenting: `python check_unaccented_terms.py`
- [ ] Backup database
- [ ] Check .env cÃ³ Ä‘Ãºng production values

### Deployment Steps

1. **Setup Environment**
   
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   # or
   venv\Scripts\activate  # Windows
   pip install -r requirements.txt
   ```

2. **Configure Database**
   
   ```bash
   # Táº¡o database
   psql -h <host> -U <user> -c "CREATE DATABASE chatbotR3"
   
   # Apply schema
   psql -h <host> -U <user> -d chatbotR3 -f 01_schema_v13.sql
   ```

3. **Setup Models**
   
   ```bash
   # Models sáº½ tá»± download láº§n Ä‘áº§u cháº¡y
   # Hoáº·c copy tá»« ./models/ directory
   ```

4. **Import Initial Data**
   
   ```bash
   # Copy export files vÃ o exports/
   python import_new_exports.py
   ```

5. **Verify Deployment**
   
   ```bash
   python quick_smoke_test.py
   # All checks should be [OK]
   ```

### Post-Deployment

- [ ] Monitor logs for errors
- [ ] Check search quality
- [ ] Verify BM25 scores reasonable
- [ ] Monitor query performance
- [ ] Setup backup schedule

---

## CAP NHAT 09-17 Oct 2025

### Substring Search Engine (17 Oct 2025)

- **Module**: `src/core/search/substring_search_engine.py` (async exact/partial match).
- **Orchestrator**: Them vao `search_orchestrator` lam fallback cho query ASCII hoac khi semantic/BM25 khong co ket qua.
- **Database**: Bat `pg_trgm` + index `idx_chunk_content_trgm` de tang toc `ILIKE` / fuzzy search.
- **Testing**: Dung endpoint `/api/v1/search/substring` hoac hybrid; xem `update_substring_17Oct.md`.

### Semantic Filter API (09 Oct 2025)

- **Endpoints**: `GET /semantic-filter/health`, `GET /semantic-filter/collections`, `POST /semantic-filter`.
- **Files moi**: `semantic_filter_service.py`, `semantic_filter_models.py`, `semantic_engine_adapter.py`, `tests/test_semantic_filter_api.py`.
- **Tinh nang**: Pure semantic search, metadata filters ($and/$or/$in/$contains), min similarity, execution metrics.
- **Tai lieu**: `UPDATE_SUMMARY_9Oct.md`, `QUICK_START_SEMANTIC_FILTER.md`, `docs/API_SEMANTIC_FILTER.md`, `IMPLEMENTATION_COMPLETE.md`.

## Káº¾T LUáº¬N

### Tráº¡ng ThÃ¡i Hiá»‡n Táº¡i

âœ… **Production Ready**

- 4 documents imported successfully
- 28 chunks with 100% BM25 token coverage
- 320 unique unaccented terms
- 3,176 BM25 index entries
- All tests passing

### TÃ­nh NÄƒng HoÃ n Chá»‰nh

- âœ… Vietnamese text normalization (bá» dáº¥u)
- âœ… BM25 full-text search
- âœ… Word segmentation
- âœ… POS tagging
- âœ… Named Entity Recognition
- âœ… Import pipeline (2-file format)
- âœ… Duplicate detection
- âœ… Vector embeddings (1024-dim)
- âœ… ChromaDB integration
- Substring search fallback (pg_trgm + orchestrator integration)
- Semantic filter API (pure ChromaDB search + metadata filters)

### Metrics

- **Import speed**: 3-4 seconds per document
- **Search speed**: <100ms simple queries
- **BM25 coverage**: 100%
- **Unaccenting quality**: 100% (0 accented terms)
- **Data integrity**: 100% (all foreign keys valid)

### LiÃªn Há»‡ & Support

**Technical Issues**: Check troubleshooting section above
**Test Failures**: Run `python run_all_tests.py` for detailed errors
**Database Issues**: Check database queries section
**Performance Issues**: See performance profiling section

---

**Document Version**: 1.1
**Last Updated**: 2025-10-17
**Status**:  Complete & Production Ready (cap nhat substring + semantic filter)
**Total Development Time**: ~2 days
**Code Quality**: Fully tested (legacy 40+ cases + semantic filter pytest suite)

---

## PHá»¤ Lá»¤C

### A. File Listing

```
Total Files: 50+
Total Lines of Code: ~10,000
Test Coverage: 40+ test cases
Documentation: 8 comprehensive documents
```

### B. Performance Benchmarks

| Operation                     | Time   | Status       |
| ----------------------------- | ------ | ------------ |
| Import 1 document (7 chunks)  | 3-4s   | âœ… Good       |
| Vietnamese analysis per chunk | 500ms  | âœ… Acceptable |
| BM25 token generation         | 200ms  | âœ… Good       |
| Simple search query           | <100ms | âœ… Excellent  |
| Complex search (4+ terms)     | <200ms | âœ… Good       |

### C. Database Statistics

```
Tables: 30+
Functions: 15+
Indexes: 65+
Views: 4
Extensions: 4 (uuid-ossp, pg_trgm, btree_gin, unaccent)
```

---

**HANDOVER COMPLETED** âœ…

TÃ i liá»‡u nÃ y cung cáº¥p Ä‘áº§y Ä‘á»§ thÃ´ng tin Ä‘á»ƒ:

- âœ… Hiá»ƒu rÃµ cáº¥u trÃºc dá»± Ã¡n
- âœ… Biáº¿t cÃ¡ch cháº¡y vÃ  test
- âœ… Debug khi cÃ³ váº¥n Ä‘á»
- âœ… Deploy lÃªn production
- âœ… Maintain vÃ  extend

ChÃºc lÃ m viá»‡c hiá»‡u quáº£! ğŸš€


