N·∫øu ƒë√£ ƒë·ªß th√¥ng tin h√£y gi√∫p t√¥i vi·∫øt t√†i li·ªáu thi·∫øt k·∫ø module d∆∞·ªõi ƒë√¢y.
T√†i li·ªáu n√†y cung c·∫•p roadmap ƒë·∫ßy ƒë·ªß ƒë·ªÉ implement FR-04.1 m√† kh√¥ng c·∫ßn code c·ª• th·ªÉ nh∆∞ng 
c√≥ c√°c b∆∞·ªõc l√†m c·ª• th·ªÉ nh∆∞ chu·∫©n b·ªã m√¥i tr∆∞·ªùng PC th·∫ø n√†o, ph·∫ßn m·ªÅm g√¨?
 ƒë·ªÉ Team k·ªπ thu·∫≠t c√≥ th·ªÉ follow step-by-step guide n√†y ƒë·ªÉ thi·∫øt k·∫ø t·ªëi ∆∞u cho h·ªá th·ªëng chatbot
 v√† c√≥ mermaidchart lu·ªìng c√¥ng vi·ªác, ƒëi·ªÉm quay ƒë·∫ßu khi b·ªã fail.

### 3.4 Module RAG Core Engine (FR-04)

**FR-04.1 - Retrieval (Truy xu·∫•t)**
- Semantic search v·ªõi ƒë·ªô ch√≠nh x√°c t·ªëi thi·ªÉu 80%
- Hybrid search (k·∫øt h·ª£p semantic v√† keyword)
- Filtering theo access level c·ªßa user
- Tr·∫£ v·ªÅ top-K documents c√≥ li√™n quan (K configurable, default=5)
---
# T√ÄI LI·ªÜU THI·∫æT K·∫æ MODULE RAG CORE ENGINE
## FR-04.1 - RETRIEVAL (TRUY XU·∫§T) IMPLEMENTATION GUIDE

---

**Phi√™n b·∫£n:** 1.0  
**Ng√†y:** 01/09/2025  
**Module:** FR-04.1 - Retrieval (Truy xu·∫•t)  
**ƒê·ªëi t∆∞·ª£ng:** Team K·ªπ thu·∫≠t  

---

## 1. T·ªîNG QUAN MODULE

### 1.1 M·ª•c ti√™u
X√¢y d·ª±ng h·ªá th·ªëng truy xu·∫•t t√†i li·ªáu th√¥ng minh v·ªõi kh·∫£ nƒÉng:
- **Semantic Search**: ƒê·ªô ch√≠nh x√°c ‚â•80%
- **Hybrid Search**: K·∫øt h·ª£p semantic + keyword search
- **Access Control**: L·ªçc theo quy·ªÅn truy c·∫≠p ng∆∞·ªùi d√πng
- **Configurable Results**: Top-K documents (default K=5)

### 1.2 Ki·∫øn tr√∫c t·ªïng quan
```mermaid
graph LR
    Query[User Query] --> QueryProcessor[Query Processor]
    QueryProcessor --> SemanticEngine[Semantic Search Engine]
    QueryProcessor --> KeywordEngine[Keyword Search Engine]
    SemanticEngine --> HybridRanker[Hybrid Ranker]
    KeywordEngine --> HybridRanker
    HybridRanker --> AccessFilter[Access Control Filter]
    AccessFilter --> TopKSelector[Top-K Selector]
    TopKSelector --> Results[Final Results]
```

---

## 2. CHU·∫®N B·ªä M√îI TR∆Ø·ªúNG PH√ÅT TRI·ªÇN

### 2.1 Y√™u c·∫ßu h·ªá th·ªëng
```bash
# Hardware Requirements
CPU: ‚â•8 cores (Intel i7/AMD Ryzen 7 ho·∫∑c t∆∞∆°ng ƒë∆∞∆°ng)
RAM: ‚â•32GB (khuy·∫øn ngh·ªã 64GB cho embedding operations)
Storage: ‚â•500GB SSD NVMe
GPU: Optional - NVIDIA GTX 1080 ho·∫∑c cao h∆°n (ƒë·ªÉ ch·∫°y local embedding models)

# Operating System
Ubuntu 22.04 LTS / CentOS 8 / Windows 11 Pro
Docker Desktop 4.0+ v·ªõi WSL2 (n·∫øu d√πng Windows)
```

### 2.2 C√†i ƒë·∫∑t m√¥i tr∆∞·ªùng c∆° b·∫£n

#### **B∆∞·ªõc 1: C√†i ƒë·∫∑t Python v√† dependencies**
```bash
# C√†i ƒë·∫∑t Python 3.11
sudo apt update
sudo apt install python3.11 python3.11-venv python3.11-dev
python3.11 -m pip install --upgrade pip

# T·∫°o virtual environment
python3.11 -m venv rag_env
source rag_env/bin/activate

# C√†i ƒë·∫∑t core libraries
pip install -r requirements.txt
```

#### **requirements.txt**
```txt
# Core Libraries
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
python-multipart==0.0.6

# Vector Search & Embeddings
chromadb==0.4.18
sentence-transformers==2.2.2
transformers==4.35.2
torch==2.1.1
faiss-cpu==1.7.4  # ho·∫∑c faiss-gpu n·∫øu c√≥ GPU

# Full-text Search
elasticsearch==8.11.0
whoosh==2.7.4  # lightweight alternative

# Database & Caching
asyncpg==0.29.0
redis==5.0.1
sqlalchemy[asyncio]==2.0.23

# Utilities
numpy==1.24.3
pandas==2.0.3
scikit-learn==1.3.2
nltk==3.8.1
spacy==3.7.2

# Testing & Development
pytest==7.4.3
pytest-asyncio==0.21.1
black==23.11.0
flake8==6.1.0
```

#### **B∆∞·ªõc 2: C√†i ƒë·∫∑t Docker v√† Database services**
```bash
# C√†i ƒë·∫∑t Docker
sudo apt install docker.io docker-compose
sudo usermod -aG docker $USER

# Kh·ªüi t·∫°o services b·∫±ng Docker Compose
# T·∫°o file docker-compose.yml (xem ph·∫ßn ph·ª• l·ª•c)
docker-compose up -d postgres redis elasticsearch
```

#### **B∆∞·ªõc 3: C√†i ƒë·∫∑t c√°c c√¥ng c·ª• ph√°t tri·ªÉn**
```bash
# VSCode v·ªõi Python extensions
# Ho·∫∑c PyCharm Professional

# Git v√† version control
git config --global user.name "Your Name"
git config --global user.email "your.email@company.com"

# Postman ho·∫∑c curl ƒë·ªÉ test APIs
# DBeaver ƒë·ªÉ qu·∫£n l√Ω database
```

---

## 3. IMPLEMENTATION ROADMAP

### 3.1 Workflow t·ªïng th·ªÉ

```mermaid
graph TD
    Start([üöÄ Start Implementation]) --> Setup[üì¶ Setup Environment]
    
    Setup --> Phase1[üî§ Phase 1: Text Preprocessing]
    Phase1 --> TestPhase1{‚úÖ Test Phase 1}
    TestPhase1 -->|‚ùå Fail| Debug1[üêõ Debug Text Processing]
    Debug1 --> Phase1
    TestPhase1 -->|‚úÖ Pass| Phase2[üî¢ Phase 2: Embedding Engine]
    
    Phase2 --> TestPhase2{‚úÖ Test Phase 2}
    TestPhase2 -->|‚ùå Fail| Debug2[üêõ Debug Embedding]
    Debug2 --> Phase2
    TestPhase2 -->|‚úÖ Pass| Phase3[üîç Phase 3: Vector Search]
    
    Phase3 --> TestPhase3{‚úÖ Test Phase 3}
    TestPhase3 -->|‚ùå Fail| Debug3[üêõ Debug Vector Search]
    Debug3 --> Phase3
    TestPhase3 -->|‚úÖ Pass| Phase4[üîé Phase 4: Keyword Search]
    
    Phase4 --> TestPhase4{‚úÖ Test Phase 4}
    TestPhase4 -->|‚ùå Fail| Debug4[üêõ Debug Keyword Search]
    Debug4 --> Phase4
    TestPhase4 -->|‚úÖ Pass| Phase5[‚öñÔ∏è Phase 5: Hybrid Ranking]
    
    Phase5 --> TestPhase5{‚úÖ Test Phase 5}
    TestPhase5 -->|‚ùå Fail| Debug5[üêõ Debug Hybrid Ranking]
    Debug5 --> Phase5
    TestPhase5 -->|‚úÖ Pass| Phase6[üõ°Ô∏è Phase 6: Access Control]
    
    Phase6 --> TestPhase6{‚úÖ Test Phase 6}
    TestPhase6 -->|‚ùå Fail| Debug6[üêõ Debug Access Control]
    Debug6 --> Phase6
    TestPhase6 -->|‚úÖ Pass| Phase7[üéØ Phase 7: API Integration]
    
    Phase7 --> TestPhase7{‚úÖ Test Phase 7}
    TestPhase7 -->|‚ùå Fail| Debug7[üêõ Debug API]
    Debug7 --> Phase7
    TestPhase7 -->|‚úÖ Pass| FinalTest[üèÅ End-to-End Testing]
    
    FinalTest --> Deploy([üöÄ Ready for Deployment])
    
    %% Styling
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:2px,color:#fff
    classDef phase fill:#2196f3,stroke:#1565c0,stroke-width:2px,color:#fff
    classDef test fill:#ff9800,stroke:#ef6c00,stroke-width:2px,color:#fff
    classDef debug fill:#f44336,stroke:#c62828,stroke-width:2px,color:#fff
    
    class Start,Deploy startEnd
    class Phase1,Phase2,Phase3,Phase4,Phase5,Phase6,Phase7 phase
    class TestPhase1,TestPhase2,TestPhase3,TestPhase4,TestPhase5,TestPhase6,TestPhase7,FinalTest test
    class Debug1,Debug2,Debug3,Debug4,Debug5,Debug6,Debug7 debug
```

---

## 4. CHI TI·∫æT TRI·ªÇN KHAI T·ª™NG PHASE

### **PHASE 1: üî§ TEXT PREPROCESSING ENGINE**

#### **M·ª•c ti√™u:** Chu·∫©n h√≥a v√† x·ª≠ l√Ω query ƒë·∫ßu v√†o
#### **Th·ªùi gian:** 2-3 ng√†y
#### **Output:** Query ƒë∆∞·ª£c l√†m s·∫°ch v√† t·ªëi ∆∞u

#### **B∆∞·ªõc 1.1: T·∫°o Text Preprocessor**
```python
# T·∫°o file: src/retrieval/text_processor.py
# Implement c√°c functions:
# - normalize_vietnamese_text()
# - remove_stopwords()
# - expand_abbreviations()  
# - handle_special_characters()
```

#### **B∆∞·ªõc 1.2: T·∫°o Query Enhancer**
```python
# T·∫°o file: src/retrieval/query_enhancer.py
# Implement:
# - query_expansion() # m·ªü r·ªông t·ª´ ƒë·ªìng nghƒ©a
# - intent_detection() # ph√°t hi·ªán √Ω ƒë·ªãnh c√¢u h·ªèi
# - context_enrichment() # l√†m phong ph√∫ ng·ªØ c·∫£nh
```

#### **B∆∞·ªõc 1.3: Unit Tests**
```bash
# T·∫°o test cases
pytest tests/test_text_processor.py -v
pytest tests/test_query_enhancer.py -v

# Test v·ªõi d·ªØ li·ªáu th·∫≠t
python scripts/test_vietnamese_processing.py
```

#### **üîÑ Checkpoint 1: Text Processing**
- [ ] Vietnamese text ƒë∆∞·ª£c normalize ch√≠nh x√°c
- [ ] Stopwords ƒë∆∞·ª£c lo·∫°i b·ªè ƒë√∫ng 
- [ ] Query expansion ho·∫°t ƒë·ªông v·ªõi t·ª´ ƒë·ªìng nghƒ©a
- [ ] Performance: <100ms cho 1 query

#### **‚ùå ƒêi·ªÉm quay ƒë·∫ßu n·∫øu fail:**
- **V·∫•n ƒë·ªÅ encoding**: Ki·ªÉm tra UTF-8, Unicode normalization
- **Vietnamese processing l·ªói**: S·ª≠ d·ª•ng th∆∞ vi·ªán `underthesea` ho·∫∑c `pyvi`
- **Performance ch·∫≠m**: Cache k·∫øt qu·∫£, optimize regex patterns

---

### **PHASE 2: üî¢ EMBEDDING ENGINE**

#### **M·ª•c ti√™u:** T·∫°o vector representations cho text
#### **Th·ªùi gian:** 3-4 ng√†y
#### **Output:** High-quality embeddings cho search

#### **B∆∞·ªõc 2.1: Model Selection v√† Setup**
```python
# T·∫°o file: src/retrieval/embedding_models.py
# Implement support cho multiple models:
# - sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
# - sentence-transformers/distiluse-base-multilingual-cased  
# - OpenAI text-embedding-ada-002 (via API)
# - Local Vietnamese models n·∫øu c√≥
```

#### **B∆∞·ªõc 2.2: Embedding Service**
```python
# T·∫°o file: src/retrieval/embedding_service.py
# Implement:
# - batch_encode() # x·ª≠ l√Ω nhi·ªÅu text c√πng l√∫c
# - cache_embeddings() # cache ƒë·ªÉ tr√°nh t√≠nh to√°n l·∫°i
# - model_comparison() # so s√°nh performance c√°c models
```

#### **B∆∞·ªõc 2.3: Vector Storage Interface**
```python
# T·∫°o file: src/retrieval/vector_store.py
# Implement adapters cho:
# - ChromaDB (recommend for development)
# - FAISS (for production performance)
# - Weaviate (if need advanced features)
```

#### **üîÑ Checkpoint 2: Embedding Engine**
- [ ] Multiple embedding models ho·∫°t ƒë·ªông
- [ ] Batch processing v·ªõi performance t·ªëi ∆∞u
- [ ] Vector storage v√† retrieval ch√≠nh x√°c
- [ ] Cache ho·∫°t ƒë·ªông ƒë√∫ng (hit rate >70%)

#### **‚ùå ƒêi·ªÉm quay ƒë·∫ßu n·∫øu fail:**
- **Model load l·ªói**: Check GPU/CPU compatibility, memory available
- **Embedding quality th·∫•p**: Test v·ªõi Vietnamese benchmark datasets
- **Performance issues**: Implement batch processing, use GPU if available
- **Storage connection fail**: Verify database connectivity, check ports

---

### **PHASE 3: üîç VECTOR SEARCH ENGINE**

#### **M·ª•c ti√™u:** Semantic search v·ªõi cosine similarity
#### **Th·ªùi gian:** 3-4 ng√†y  
#### **Output:** Top-K similar documents v·ªõi scores

#### **B∆∞·ªõc 3.1: Similarity Search**
```python
# T·∫°o file: src/retrieval/semantic_search.py
# Implement:
# - cosine_similarity_search()
# - approximate_search() # using FAISS/Annoy for speed
# - result_scoring() # normalize scores 0-1
```

#### **B∆∞·ªõc 3.2: Search Optimization**  
```python
# Implement trong semantic_search.py:
# - index_optimization() # tune FAISS parameters
# - query_preprocessing() # optimize query embeddings
# - result_postprocessing() # filter and rank results
```

#### **B∆∞·ªõc 3.3: Performance Benchmarking**
```python
# T·∫°o file: scripts/benchmark_semantic_search.py
# Test v·ªõi:
# - Different similarity thresholds (0.5, 0.6, 0.7, 0.8)
# - Various K values (5, 10, 20, 50)  
# - Different index configurations
```

#### **üîÑ Checkpoint 3: Vector Search**
- [ ] Semantic search accuracy ‚â•80% tr√™n test dataset
- [ ] Search response time <500ms cho 10K documents
- [ ] Similarity scores ƒë∆∞·ª£c normalize ch√≠nh x√°c
- [ ] Index ƒë∆∞·ª£c optimize cho performance

#### **‚ùå ƒêi·ªÉm quay ƒë·∫ßu n·∫øu fail:**
- **Low accuracy**: Ki·ªÉm tra embedding model, tune similarity threshold
- **Slow performance**: Optimize vector index, check hardware resources
- **Memory issues**: Implement streaming search, reduce batch sizes
- **Inconsistent results**: Debug vector normalization, check data quality

---

### **PHASE 4: üîé KEYWORD SEARCH ENGINE**

#### **M·ª•c ti√™u:** Full-text search v·ªõi BM25 scoring
#### **Th·ªùi gian:** 2-3 ng√†y
#### **Output:** Keyword-based document ranking

#### **B∆∞·ªõc 4.1: Full-text Indexing**
```python
# T·∫°o file: src/retrieval/keyword_search.py
# Implement:
# - build_inverted_index() # t·∫°o inverted index
# - bm25_scoring() # implement BM25 algorithm
# - vietnamese_tokenization() # tokenize ti·∫øng Vi·ªát
```

#### **B∆∞·ªõc 4.2: Search Engine Implementation**
```python
# Implement trong keyword_search.py:
# - exact_match_search() # t√¨m ki·∫øm ch√≠nh x√°c
# - fuzzy_search() # t√¨m ki·∫øm m·ªù v·ªõi edit distance
# - phrase_search() # t√¨m c·ª•m t·ª´
# - boolean_search() # AND, OR, NOT operators
```

#### **B∆∞·ªõc 4.3: Integration v·ªõi Elasticsearch (Optional)**
```python
# T·∫°o file: src/retrieval/elasticsearch_adapter.py
# Implement n·∫øu mu·ªën d√πng Elasticsearch:
# - index_documents()
# - search_documents() 
# - custom_analyzers() # cho ti·∫øng Vi·ªát
```

#### **üîÑ Checkpoint 4: Keyword Search**
- [ ] BM25 scoring ho·∫°t ƒë·ªông ch√≠nh x√°c
- [ ] Vietnamese tokenization t·ªët
- [ ] Support exact match v√† fuzzy search
- [ ] Performance <300ms cho keyword queries

#### **‚ùå ƒêi·ªÉm quay ƒë·∫ßu n·∫øu fail:**
- **Tokenization issues**: S·ª≠ d·ª•ng `underthesea` cho Vietnamese NLP
- **Poor BM25 scores**: Tune k1, b parameters, verify document frequencies
- **Memory consumption**: Optimize inverted index structure
- **Elasticsearch connection**: Check cluster health, verify indices

---

### **PHASE 5: ‚öñÔ∏è HYBRID RANKING ENGINE**

#### **M·ª•c ti√™u:** K·∫øt h·ª£p semantic + keyword search
#### **Th·ªùi gian:** 4-5 ng√†y
#### **Output:** Unified ranking system

#### **B∆∞·ªõc 5.1: Score Normalization**
```python
# T·∫°o file: src/retrieval/score_normalizer.py
# Implement:
# - normalize_semantic_scores() # 0-1 range
# - normalize_keyword_scores() # 0-1 range  
# - calibrate_score_ranges() # ƒë·∫£m b·∫£o fair comparison
```

#### **B∆∞·ªõc 5.2: Hybrid Ranking Algorithm**
```python
# T·∫°o file: src/retrieval/hybrid_ranker.py
# Implement multiple strategies:
# - weighted_combination() # Œ±*semantic + Œ≤*keyword
# - rank_fusion() # RRF (Reciprocal Rank Fusion)
# - machine_learning_ranker() # ML-based combination
```

#### **B∆∞·ªõc 5.3: Parameter Tuning**
```python
# T·∫°o file: scripts/tune_hybrid_parameters.py
# Implement:
# - grid_search_weights() # t√¨m Œ±, Œ≤ optimal
# - cross_validation() # validate tr√™n multiple datasets
# - a_b_testing() # test different strategies
```

#### **üîÑ Checkpoint 5: Hybrid Ranking**
- [ ] Hybrid search outperform individual methods
- [ ] Optimal weights ƒë∆∞·ª£c t√¨m th·∫•y qua tuning
- [ ] Consistent ranking across different query types
- [ ] Performance <800ms cho hybrid search

#### **‚ùå ƒêi·ªÉm quay ƒë·∫ßu n·∫øu fail:**
- **Poor hybrid performance**: Re-examine score normalization methods
- **Inconsistent results**: Debug score calibration, check data distributions
- **Parameter tuning slow**: Implement parallel grid search
- **Overfitting**: Use more diverse validation datasets

---

### **PHASE 6: üõ°Ô∏è ACCESS CONTROL FILTER**

#### **M·ª•c ti√™u:** Filter results theo user permissions
#### **Th·ªùi gian:** 3-4 ng√†y
#### **Output:** Permission-aware search results

#### **B∆∞·ªõc 6.1: Permission Service**
```python
# T·∫°o file: src/retrieval/permission_service.py
# Implement:
# - get_user_permissions() # l·∫•y quy·ªÅn t·ª´ database
# - check_document_access() # ki·ªÉm tra quy·ªÅn truy c·∫≠p doc
# - cache_permissions() # cache ƒë·ªÉ performance
```

#### **B∆∞·ªõc 6.2: Access Control Filter**
```python
# T·∫°o file: src/retrieval/access_filter.py
# Implement:
# - filter_by_access_level() # l·ªçc theo c·∫•p ƒë·ªô truy c·∫≠p
# - filter_by_department() # l·ªçc theo ph√≤ng ban
# - filter_by_tags() # l·ªçc theo tags/categories
# - audit_access_attempts() # log access attempts
```

#### **B∆∞·ªõc 6.3: Security Testing**
```python
# T·∫°o file: tests/test_security.py
# Test cases:
# - User kh√¥ng th·ªÉ truy c·∫≠p docs c·∫•p cao h∆°n
# - Department isolation ho·∫°t ƒë·ªông
# - Permission changes ƒë∆∞·ª£c reflect immediately
# - No information leakage qua search results
```

#### **üîÑ Checkpoint 6: Access Control**
- [ ] 100% accuracy trong permission filtering
- [ ] No data leakage ra unauthorized users
- [ ] Performance impact <100ms overhead
- [ ] Comprehensive audit logging

#### **‚ùå ƒêi·ªÉm quay ƒë·∫ßu n·∫øu fail:**
- **Permission leaks**: Review filter logic, add more test cases
- **Performance degradation**: Optimize permission caching
- **Database connection issues**: Check connection pooling
- **Audit logging fails**: Verify logging infrastructure

---

### **PHASE 7: üéØ API INTEGRATION**

#### **M·ª•c ti√™u:** Expose retrieval qua REST API
#### **Th·ªùi gian:** 3-4 ng√†y
#### **Output:** Production-ready API endpoints

#### **B∆∞·ªõc 7.1: FastAPI Application**
```python
# T·∫°o file: src/api/retrieval_api.py
# Implement endpoints:
# - POST /api/search/semantic
# - POST /api/search/keyword  
# - POST /api/search/hybrid
# - GET /api/search/config
```

#### **B∆∞·ªõc 7.2: Request/Response Models**
```python
# T·∫°o file: src/api/models.py
# Define Pydantic models:
# - SearchRequest
# - SearchResponse
# - DocumentResult
# - ErrorResponse
```

#### **B∆∞·ªõc 7.3: Error Handling & Validation**
```python
# Implement trong retrieval_api.py:
# - input_validation() # validate search parameters
# - exception_handling() # handle errors gracefully  
# - rate_limiting() # prevent API abuse
# - response_caching() # cache common queries
```

#### **üîÑ Checkpoint 7: API Integration**
- [ ] All endpoints ho·∫°t ƒë·ªông ƒë√∫ng
- [ ] Input validation comprehensive
- [ ] Error responses user-friendly
- [ ] API documentation complete (Swagger)

#### **‚ùå ƒêi·ªÉm quay ƒë·∫ßu n·∫øu fail:**
- **API errors**: Check request/response serialization
- **Validation issues**: Review Pydantic models
- **Performance problems**: Implement async processing
- **Documentation incomplete**: Use FastAPI auto-documentation

---

## 5. TESTING STRATEGY

### 5.1 Unit Testing Plan

```python
# Test Structure
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ test_text_processor.py
‚îÇ   ‚îú‚îÄ‚îÄ test_embedding_service.py  
‚îÇ   ‚îú‚îÄ‚îÄ test_semantic_search.py
‚îÇ   ‚îú‚îÄ‚îÄ test_keyword_search.py
‚îÇ   ‚îú‚îÄ‚îÄ test_hybrid_ranker.py
‚îÇ   ‚îú‚îÄ‚îÄ test_access_filter.py
‚îÇ   ‚îî‚îÄ‚îÄ test_api.py
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ test_end_to_end.py
‚îÇ   ‚îú‚îÄ‚îÄ test_database_integration.py
‚îÇ   ‚îî‚îÄ‚îÄ test_performance.py
‚îî‚îÄ‚îÄ fixtures/
    ‚îú‚îÄ‚îÄ sample_documents.json
    ‚îú‚îÄ‚îÄ test_queries.json
    ‚îî‚îÄ‚îÄ user_permissions.json
```

### 5.2 Test Cases ch√≠nh

#### **Functional Tests:**
```python
def test_semantic_search_accuracy():
    """Test semantic search achieves ‚â•80% accuracy"""
    # Load test dataset v·ªõi ground truth
    # Run semantic search
    # Calculate precision@K, recall@K
    assert accuracy >= 0.8

def test_hybrid_search_improvement():  
    """Test hybrid search better than individual methods"""
    # Compare hybrid vs semantic vs keyword
    assert hybrid_score > max(semantic_score, keyword_score)

def test_access_control_security():
    """Test no unauthorized access to documents"""
    # Test v·ªõi different user roles
    # Verify no leakage occurs
    assert no_unauthorized_docs_returned
```

#### **Performance Tests:**
```python
def test_search_response_time():
    """Test search responds within time limits"""
    # Test v·ªõi different query types v√† document counts
    assert response_time < 1.0  # seconds

def test_concurrent_users():
    """Test system handles multiple concurrent searches"""
    # Simulate 100 concurrent users
    assert all_requests_successful
```

### 5.3 Acceptance Criteria Checklist

- [ ] **Semantic search accuracy ‚â•80%** tr√™n test dataset
- [ ] **Hybrid search outperforms** individual methods
- [ ] **Access control 100% accurate** - no permission leaks
- [ ] **Top-K configurable** v·ªõi default K=5
- [ ] **Response time <1 second** cho 95% requests
- [ ] **API documentation complete** v·ªõi examples
- [ ] **Error handling graceful** v·ªõi meaningful messages
- [ ] **Security tested** v·ªõi penetration testing

---

## 6. DEPLOYMENT CONFIGURATION

### 6.1 Production Environment Setup

#### **Docker Configuration**
```dockerfile
# Dockerfile cho retrieval service
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY src/ ./src/
COPY config/ ./config/

EXPOSE 8000
CMD ["uvicorn", "src.api.retrieval_api:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### **Environment Variables**
```bash
# .env file
VECTOR_DB_URL=http://chromadb:8000
POSTGRES_URL=postgresql://user:pass@postgres:5432/knowledge_db
REDIS_URL=redis://redis:6379/0
ELASTICSEARCH_URL=http://elasticsearch:9200

# Model configurations
EMBEDDING_MODEL=sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
EMBEDDING_CACHE_SIZE=10000
SEARCH_DEFAULT_K=5
HYBRID_SEMANTIC_WEIGHT=0.7
HYBRID_KEYWORD_WEIGHT=0.3

# Performance settings
MAX_CONCURRENT_SEARCHES=50
CACHE_TTL_SECONDS=3600
```

### 6.2 Monitoring & Logging

#### **Metrics to Track:**
```python
# Key Performance Indicators
- Search accuracy (precision@5, recall@5)  
- Response time (p95, p99)
- Query volume per minute
- Cache hit rate
- Error rate
- User satisfaction scores
```

#### **Logging Configuration:**
```python
# Structured logging v·ªõi JSON format
{
    "timestamp": "2025-09-01T10:00:00Z",
    "level": "INFO", 
    "service": "retrieval-engine",
    "user_id": "emp001",
    "query": "quy tr√¨nh mua h√†ng",
    "search_type": "hybrid",
    "results_count": 5,
    "response_time_ms": 423,
    "accuracy_score": 0.87
}
```

---

## 7. TROUBLESHOOTING GUIDE

### 7.1 Common Issues & Solutions

| V·∫•n ƒë·ªÅ | Tri·ªáu ch·ª©ng | Gi·∫£i ph√°p |
|--------|-------------|-----------|
| **Low Search Accuracy** | Results kh√¥ng relevant | ‚Ä¢ Retrain embedding model<br/>‚Ä¢ Tune similarity thresholds<br/>‚Ä¢ Improve data quality |
| **Slow Response Time** | Timeout errors, user complaints | ‚Ä¢ Optimize vector indices<br/>‚Ä¢ Implement caching<br/>‚Ä¢ Scale horizontally |
| **Memory Issues** | OOM errors, crashes | ‚Ä¢ Reduce batch sizes<br/>‚Ä¢ Use streaming processing<br/>‚Ä¢ Add more RAM |
| **Permission Errors** | Users see restricted docs | ‚Ä¢ Review access control logic<br/>‚Ä¢ Clear permission cache<br/>‚Ä¢ Check database sync |

### 7.2 Debug Commands

```bash
# Check service health
curl http://localhost:8000/health

# Test search endpoint
curl -X POST http://localhost:8000/api/search/hybrid \
  -H "Content-Type: application/json" \
  -d '{"query": "quy tr√¨nh mua h√†ng", "user_id": "emp001", "k": 5}'

# Check vector database
curl http://chromadb:8000/api/v1/collections

# Monitor logs
docker logs -f retrieval-service

# Performance monitoring
python scripts/benchmark_search.py --queries=100 --concurrent=10
```

---

## 8. PERFORMANCE BENCHMARKS

### 8.1 Target Metrics

| Metric | Target | Measurement Method |
|--------|--------|--------------------|
| **Search Accuracy** | ‚â•80% | Precision@5 on test dataset |
| **Response Time** | <1 second | p95 latency |
| **Throughput** | 100 QPS | Concurrent users simulation |
| **Cache Hit Rate** | >70% | Redis metrics |
| **Memory Usage** | <8GB | Container monitoring |
| **CPU Utilization** | <80% | System monitoring |

### 8.2 Benchmark Scripts

```python
# scripts/benchmark_retrieval.py
import asyncio
import time
from concurrent.futures import ThreadPoolExecutor

async def benchmark_search_performance():
    """Benchmark search performance with different parameters"""
    # Test v·ªõi different query types
    # Measure response times
    # Generate performance report

def benchmark_accuracy():
    """Measure search accuracy against ground truth"""
    # Load test queries v·ªõi expected results
    # Run search engine
    # Calculate precision, recall, F1-score

def stress_test():
    """Test system under high load"""
    # Simulate high concurrent load
    # Monitor system resources
    # Identify breaking points
```

---

## 9. PH·ª§C L·ª§C

### 9.1 Docker Compose Configuration

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: knowledge_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - chromadb_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_PORT=8000

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data

volumes:
  postgres_data:
  redis_data:
  chromadb_data:
  elasticsearch_data:
```

### 9.2 Sample Test Data Structure

```json
{
  "test_documents": [
    {
      "doc_id": "proc_001",
      "title": "Quy tr√¨nh Mua h√†ng",
      "content": "Quy tr√¨nh mua h√†ng g·ªìm 5 b∆∞·ªõc ch√≠nh...",
      "access_level": "employee_only",
      "department": "procurement",
      "tags": ["procurement", "process", "approval"]
    }
  ],
  "test_queries": [
    {
      "query": "l√†m th·∫ø n√†o ƒë·ªÉ mua h√†ng",
      "expected_docs": ["proc_001", "proc_002"],
      "user_role": "employee"
    }
  ]
}
```

### 9.3 API Documentation Sample

```yaml
# OpenAPI specification
openapi: 3.0.0
info:
  title: Document Retrieval API
  version: 1.0.0

paths:
  /api/search/hybrid:
    post:
      summary: Hybrid search combining semantic and keyword search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
                  description: Search query
                user_id:
                  type: string
                  description: User identifier for access control
                k:
                  type: integer
                  default: 5
                  description: Number of results to return
      responses:
        200:
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object
                  total_count:
                    type: integer
