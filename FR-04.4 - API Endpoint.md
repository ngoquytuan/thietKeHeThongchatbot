Náº¿u Ä‘Ã£ Ä‘á»§ thÃ´ng tin hÃ£y giÃºp tÃ´i viáº¿t tÃ i liá»‡u thiáº¿t káº¿ module dÆ°á»›i Ä‘Ã¢y.
TÃ i liá»‡u nÃ y cung cáº¥p roadmap Ä‘áº§y Ä‘á»§ Ä‘á»ƒ implement FR-04.4 mÃ  khÃ´ng cáº§n code cá»¥ thá»ƒ nhÆ°ng 
cÃ³ cÃ¡c bÆ°á»›c lÃ m cá»¥ thá»ƒ nhÆ° chuáº©n bá»‹ mÃ´i trÆ°á»ng PC tháº¿ nÃ o, pháº§n má»m gÃ¬?
 Ä‘á»ƒ Team ká»¹ thuáº­t cÃ³ thá»ƒ follow step-by-step guide nÃ y Ä‘á»ƒ thiáº¿t káº¿ tá»‘i Æ°u cho há»‡ thá»‘ng chatbot
 vÃ  cÃ³ mermaidchart luá»“ng cÃ´ng viá»‡c, Ä‘iá»ƒm quay Ä‘áº§u khi bá»‹ fail.

### 3.4 Module RAG Core Engine (FR-04)

**FR-04.4 - API Endpoint**
- `/api/ask` - Endpoint chÃ­nh cho chatbot
- Input: user_query, user_id, session_id
- Output: answer, references, confidence_score
---

# TÃ€I LIá»†U THIáº¾T Káº¾ MODULE RAG CORE ENGINE
## API ENDPOINT IMPLEMENTATION GUIDE (FR-04.4)

---

**Module:** RAG Core Engine - API Endpoint  
**Feature ID:** FR-04.4  
**PhiÃªn báº£n:** 1.0  
**NgÃ y táº¡o:** 01/09/2025  
**NgÆ°á»i soáº¡n tháº£o:** Technical Architecture Team  

---

## ğŸ“‹ **Má»¤C Lá»¤C**
1. [Tá»•ng quan Module](#1-tá»•ng-quan-module)
2. [Kiáº¿n trÃºc API Endpoint](#2-kiáº¿n-trÃºc-api-endpoint)
3. [Chuáº©n bá»‹ MÃ´i trÆ°á»ng PhÃ¡t triá»ƒn](#3-chuáº©n-bá»‹-mÃ´i-trÆ°á»ng-phÃ¡t-triá»ƒn)
4. [Roadmap Implementation](#4-roadmap-implementation)
5. [Luá»“ng xá»­ lÃ½ chi tiáº¿t](#5-luá»“ng-xá»­-lÃ½-chi-tiáº¿t)
6. [Error Handling & Recovery](#6-error-handling--recovery)
7. [Testing Strategy](#7-testing-strategy)
8. [Monitoring & Performance](#8-monitoring--performance)

---

## 1. **Tá»”NG QUAN MODULE**

### 1.1 MÃ´ táº£ chá»©c nÄƒng
API Endpoint `/api/ask` lÃ  trÃ¡i tim cá»§a há»‡ thá»‘ng RAG, xá»­ lÃ½ táº¥t cáº£ cÃ¡c yÃªu cáº§u tá»« chatbot frontend vÃ  tráº£ vá» cÃ¢u tráº£ lá»i thÃ´ng minh dá»±a trÃªn tri thá»©c ná»™i bá»™.

### 1.2 Input/Output Specification

**ğŸ“¥ INPUT:**
```json
{
  "user_query": "Quy trÃ¬nh mua hÃ ng trÃ¬nh giÃ¡m Ä‘á»‘c nhÆ° tháº¿ nÃ o?",
  "user_id": "emp001", 
  "session_id": "sess_20250901_001",
  "department": "rd",
  "language": "vi",
  "context_history": ["previous_question_1", "previous_question_2"],
  "max_results": 5,
  "include_citations": true
}
```

**ğŸ“¤ OUTPUT:**
```json
{
  "status": "success",
  "answer": "Quy trÃ¬nh mua hÃ ng trÃ¬nh giÃ¡m Ä‘á»‘c gá»“m 5 bÆ°á»›c chÃ­nh...",
  "references": [
    {
      "doc_id": "proc_001",
      "title": "Quy trÃ¬nh Mua hÃ ng CÃ´ng ty",
      "chunk_text": "BÆ°á»›c 1: Táº¡o yÃªu cáº§u mua hÃ ng trong há»‡ thá»‘ng...",
      "confidence_score": 0.95,
      "page_number": 3,
      "section": "2.1 Quy trÃ¬nh cÆ¡ báº£n"
    }
  ],
  "confidence_score": 0.89,
  "response_time_ms": 2340,
  "session_id": "sess_20250901_001",
  "cached": false,
  "fallback_used": false
}
```

### 1.3 Performance Requirements
- **Response Time**: < 60 seconds (target: < 10 seconds)
- **Throughput**: 100 concurrent requests
- **Availability**: 99.5% uptime
- **Accuracy**: â‰¥80% relevant responses

---

## 2. **KIáº¾N TRÃšC API ENDPOINT**

### 2.1 Component Architecture

```mermaid
graph TB
    subgraph "ğŸŒ API Layer"
        FastAPI[âš¡ FastAPI Server<br/>Python 3.11+]
        Router[ğŸ›¤ï¸ API Router<br/>/api/ask endpoint]
        Validator[âœ… Request Validator<br/>Pydantic models]
        Auth[ğŸ” Authentication<br/>JWT + RBAC]
    end
    
    subgraph "ğŸ§  RAG Processing Layer" 
        Orchestrator[ğŸ¯ RAG Orchestrator<br/>Main business logic]
        
        subgraph "Query Processing"
            QueryProcessor[ğŸ” Query Processor<br/>NLP preprocessing]
            IntentDetector[ğŸ¯ Intent Detector<br/>Question classification]
        end
        
        subgraph "Document Retrieval"
            VectorSearch[ğŸ“Š Vector Search<br/>Semantic similarity]
            PermissionFilter[ğŸ›¡ï¸ Permission Filter<br/>Access control]
            ResultRanker[ğŸ“ˆ Result Ranker<br/>Relevance scoring]
        end
        
        subgraph "Response Generation"
            ContextBuilder[ğŸ§© Context Builder<br/>Prompt construction]
            LLMCaller[ğŸ¤– LLM Caller<br/>External API calls]
            ResponseParser[ğŸ“ Response Parser<br/>Extract answer + citations]
        end
    end
    
    subgraph "ğŸ’¾ Data Layer"
        VectorDB[(ğŸ”¢ Vector Database)]
        PostgreSQL[(ğŸ˜ PostgreSQL)]
        Redis[(ğŸ”´ Redis Cache)]
    end
    
    subgraph "ğŸŒ External Services"
        OpenAI[ğŸ§  OpenAI API]
        Claude[ğŸ¤– Anthropic Claude]
        LocalLLM[ğŸ  Local LLM]
    end
    
    %% Flow
    Router --> Validator
    Validator --> Auth
    Auth --> Orchestrator
    
    Orchestrator --> QueryProcessor
    QueryProcessor --> IntentDetector
    IntentDetector --> VectorSearch
    VectorSearch --> PermissionFilter
    PermissionFilter --> ResultRanker
    
    ResultRanker --> ContextBuilder
    ContextBuilder --> LLMCaller
    LLMCaller --> ResponseParser
    ResponseParser --> Orchestrator
    
    %% Data connections
    VectorSearch -.-> VectorDB
    PermissionFilter -.-> PostgreSQL
    Orchestrator -.-> Redis
    
    %% External connections  
    LLMCaller -.-> OpenAI
    LLMCaller -.-> Claude
    LLMCaller -.-> LocalLLM
    
    %% Styling
    classDef api fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef processing fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef data fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef external fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    
    class FastAPI,Router,Validator,Auth api
    class Orchestrator,QueryProcessor,IntentDetector,VectorSearch,PermissionFilter,ResultRanker,ContextBuilder,LLMCaller,ResponseParser processing
    class VectorDB,PostgreSQL,Redis data
    class OpenAI,Claude,LocalLLM external
```

---

## 3. **CHUáº¨N Bá»Š MÃ”I TRÆ¯á»œNG PHÃT TRIá»‚N**

### 3.1 Hardware Requirements

| Component | Minimum | Recommended | Optimal |
|-----------|---------|-------------|---------|
| **CPU** | 8 cores | 16 cores | 32 cores |
| **RAM** | 16GB | 32GB | 64GB |
| **Storage** | 500GB SSD | 1TB NVMe SSD | 2TB NVMe SSD |
| **GPU** | None | RTX 3080 (12GB) | RTX 4090 (24GB) |
| **Network** | 1Gbps | 10Gbps | 10Gbps+ |

### 3.2 Software Stack Setup

#### 3.2.1 Operating System
```bash
# Ubuntu 22.04 LTS (Recommended)
sudo apt update && sudo apt upgrade -y
sudo apt install build-essential curl wget git -y
```

#### 3.2.2 Python Environment
```bash
# Python 3.11+ vá»›i pyenv
curl https://pyenv.run | bash
pyenv install 3.11.5
pyenv global 3.11.5

# Poetry cho dependency management  
curl -sSL https://install.python-poetry.org | python3 -
```

#### 3.2.3 Database Setup
```bash
# PostgreSQL 15+
sudo apt install postgresql-15 postgresql-contrib-15
sudo systemctl enable postgresql
sudo systemctl start postgresql

# Redis 7+
sudo apt install redis-server
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

#### 3.2.4 Vector Database
```bash
# Option 1: Chroma (Recommended for development)
pip install chromadb

# Option 2: FAISS (For production)
conda install faiss-cpu  # or faiss-gpu

# Option 3: Weaviate (Docker)
docker run -p 8080:8080 semitechnologies/weaviate:latest
```

#### 3.2.5 Development Tools
```bash
# Docker & Docker Compose
sudo apt install docker.io docker-compose-v2
sudo usermod -aG docker $USER

# VS Code vá»›i Python extensions
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
sudo install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/
```

### 3.3 Project Structure
```
rag-core-engine/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI app entry point
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ settings.py      # Environment configs
â”‚   â”‚   â””â”€â”€ database.py      # DB connections
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ ask.py       # /api/ask endpoint
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ request.py   # Pydantic request models
â”‚   â”‚   â”‚   â””â”€â”€ response.py  # Pydantic response models
â”‚   â”‚   â””â”€â”€ middleware/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ auth.py      # Authentication
â”‚   â”‚       â””â”€â”€ cors.py      # CORS handling
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ rag_orchestrator.py    # Main RAG logic
â”‚   â”‚   â”œâ”€â”€ query_processor.py     # Query preprocessing
â”‚   â”‚   â”œâ”€â”€ vector_search.py       # Vector operations
â”‚   â”‚   â”œâ”€â”€ permission_service.py  # Access control
â”‚   â”‚   â”œâ”€â”€ llm_service.py         # LLM integrations
â”‚   â”‚   â””â”€â”€ cache_service.py       # Redis operations
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ security.py      # JWT, password hashing
â”‚   â”‚   â”œâ”€â”€ logging.py       # Structured logging
â”‚   â”‚   â””â”€â”€ exceptions.py    # Custom exceptions
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ embeddings.py    # Embedding utilities
â”‚       â”œâ”€â”€ text_processing.py
â”‚       â””â”€â”€ monitoring.py    # Metrics collection
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py         # Pytest configurations
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ e2e/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ api_spec.yaml       # OpenAPI specification
â”‚   â””â”€â”€ README.md
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ setup_dev.sh        # Development setup
â”‚   â”œâ”€â”€ run_tests.sh        # Test runner
â”‚   â””â”€â”€ deploy.sh           # Deployment script
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ .dockerignore
â”œâ”€â”€ pyproject.toml          # Poetry dependencies
â”œâ”€â”€ .env.example            # Environment template
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

---

## 4. **ROADMAP IMPLEMENTATION**

### 4.1 Timeline Overview (8 tuáº§n)

| Phase | Duration | Tasks | Deliverables |
|-------|----------|-------|--------------|
| **Phase 1: Foundation** | Week 1-2 | Setup + Core Structure | Working API skeleton |
| **Phase 2: Core Logic** | Week 3-4 | RAG components | Basic query processing |
| **Phase 3: Integration** | Week 5-6 | LLM + Vector DB | End-to-end flow |
| **Phase 4: Optimization** | Week 7-8 | Performance + Testing | Production-ready API |

### 4.2 Phase-by-Phase Implementation

#### **ğŸ—ï¸ Phase 1: Foundation Setup (Week 1-2)**

**Week 1: Environment & Project Structure**
- [ ] Day 1-2: Setup development environment theo section 3
- [ ] Day 3: Initialize project structure
- [ ] Day 4: Setup FastAPI basic app vá»›i health check
- [ ] Day 5: Configure logging, metrics, database connections

**Week 2: API Framework**  
- [ ] Day 1-2: Implement Pydantic request/response models
- [ ] Day 3: Setup authentication middleware (JWT)
- [ ] Day 4: Implement basic /api/ask endpoint (mock response)
- [ ] Day 5: Add CORS, rate limiting, request validation

**ğŸ¯ Deliverable:** Working API server vá»›i basic endpoint

#### **ğŸ§  Phase 2: Core RAG Logic (Week 3-4)**

**Week 3: Query Processing**
- [ ] Day 1-2: Implement QueryProcessor (text cleaning, intent detection)
- [ ] Day 2-3: Build VectorSearch service (connect to vector DB)
- [ ] Day 4: Implement PermissionFilter (RBAC logic)
- [ ] Day 5: Create ResultRanker (relevance scoring)

**Week 4: Response Generation**
- [ ] Day 1-2: Build ContextBuilder (prompt engineering)
- [ ] Day 3: Implement LLMService (OpenAI/Claude integration)
- [ ] Day 4: Create ResponseParser (extract answer + citations)
- [ ] Day 5: Integrate all components trong RAGOrchestrator

**ğŸ¯ Deliverable:** Complete RAG processing pipeline

#### **ğŸ”— Phase 3: System Integration (Week 5-6)**

**Week 5: Database Integration**
- [ ] Day 1-2: Connect PostgreSQL cho metadata vÃ  user management
- [ ] Day 3: Integrate Redis cho caching vÃ  session
- [ ] Day 4: Setup vector database (Chroma/FAISS)  
- [ ] Day 5: Test end-to-end data flow

**Week 6: LLM & External Services**
- [ ] Day 1-2: Implement multiple LLM providers (fallback logic)
- [ ] Day 3: Add embeddings service integration
- [ ] Day 4: Build retry mechanisms vÃ  circuit breakers
- [ ] Day 5: Comprehensive integration testing

**ğŸ¯ Deliverable:** Fully integrated system vá»›i real data

#### **âš¡ Phase 4: Production Optimization (Week 7-8)**

**Week 7: Performance & Reliability**
- [ ] Day 1-2: Implement advanced caching strategies
- [ ] Day 3: Add async processing cho heavy operations
- [ ] Day 4: Optimize database queries vÃ  vector search
- [ ] Day 5: Load testing vÃ  performance tuning

**Week 8: Final Polish**
- [ ] Day 1-2: Comprehensive error handling
- [ ] Day 3: Security audit vÃ  penetration testing
- [ ] Day 4: Documentation hoÃ n thiá»‡n
- [ ] Day 5: Production deployment preparation

**ğŸ¯ Deliverable:** Production-ready API endpoint

---

## 5. **LUá»’NG Xá»¬ LÃ CHI TIáº¾T**

### 5.1 Main Processing Flow

```mermaid
flowchart TD
    Start([ğŸš€ API Request Received]) --> Validate{âœ… Request Valid?}
    
    Validate -->|âŒ No| ValidationError[ğŸš¨ Return 400<br/>Validation Error]
    Validate -->|âœ… Yes| Auth{ğŸ” Authenticated?}
    
    Auth -->|âŒ No| AuthError[ğŸš¨ Return 401<br/>Unauthorized]
    Auth -->|âœ… Yes| CheckCache{ğŸ’¾ Cache Hit?}
    
    CheckCache -->|âœ… Yes| CacheReturn[âš¡ Return Cached<br/>Response]
    CheckCache -->|âŒ No| QueryProcess[ğŸ” Process Query]
    
    QueryProcess --> IntentDetect[ğŸ¯ Detect Intent]
    IntentDetect --> VectorSearch[ğŸ“Š Vector Search]
    VectorSearch --> PermCheck{ğŸ›¡ï¸ Permission OK?}
    
    PermCheck -->|âŒ No| PermError[ğŸš¨ Return 403<br/>Forbidden]
    PermCheck -->|âœ… Yes| ResultsFound{ğŸ“‹ Results Found?}
    
    ResultsFound -->|âŒ No| NoResults[â“ No Results Found<br/>Fallback Response]
    ResultsFound -->|âœ… Yes| BuildContext[ğŸ§© Build Context]
    
    BuildContext --> CallLLM[ğŸ¤– Call LLM]
    CallLLM --> LLMSuccess{âœ… LLM Success?}
    
    LLMSuccess -->|âŒ No| LLMError{ğŸ”„ Retry Available?}
    LLMError -->|âœ… Yes| CallLLM
    LLMError -->|âŒ No| FallbackLLM[ğŸ”„ Try Fallback LLM]
    
    FallbackLLM --> FallbackSuccess{âœ… Fallback Success?}
    FallbackSuccess -->|âŒ No| GenericError[ğŸš¨ Return 503<br/>Service Unavailable]
    FallbackSuccess -->|âœ… Yes| ParseResponse[ğŸ“ Parse Response]
    
    LLMSuccess -->|âœ… Yes| ParseResponse
    ParseResponse --> ValidateResponse{âœ… Response Valid?}
    
    ValidateResponse -->|âŒ No| ResponseError[ğŸš¨ Return 500<br/>Invalid Response]
    ValidateResponse -->|âœ… Yes| CacheResponse[ğŸ’¾ Cache Response]
    
    CacheResponse --> LogMetrics[ğŸ“Š Log Metrics]
    LogMetrics --> Success[âœ¨ Return Success<br/>Response]
    
    %% Error flows lead to logging
    ValidationError --> LogError[ğŸ“ Log Error]
    AuthError --> LogError
    PermError --> LogError
    GenericError --> LogError
    ResponseError --> LogError
    LogError --> End([ğŸ End])
    
    %% Success flows
    CacheReturn --> End
    NoResults --> End
    Success --> End
    
    %% Styling
    classDef startEnd fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    classDef process fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef success fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    
    class Start,End startEnd
    class QueryProcess,IntentDetect,VectorSearch,BuildContext,CallLLM,ParseResponse,CacheResponse,LogMetrics,FallbackLLM process
    class Validate,Auth,CheckCache,PermCheck,ResultsFound,LLMSuccess,LLMError,FallbackSuccess,ValidateResponse decision
    class ValidationError,AuthError,PermError,GenericError,ResponseError,LogError error
    class CacheReturn,NoResults,Success success
```

### 5.2 Detailed Component Logic

#### **ğŸ” Query Processing Logic**
```python
# Pseudo-code for QueryProcessor
def process_query(user_query, user_context):
    # 1. Text normalization
    normalized_query = normalize_text(user_query)
    
    # 2. Intent detection  
    intent = detect_intent(normalized_query)
    
    # 3. Query expansion (if needed)
    if intent == "specific_search":
        expanded_query = expand_with_synonyms(normalized_query)
    else:
        expanded_query = normalized_query
    
    # 4. Generate embedding
    query_embedding = generate_embedding(expanded_query)
    
    return ProcessedQuery(
        original=user_query,
        normalized=normalized_query, 
        expanded=expanded_query,
        intent=intent,
        embedding=query_embedding
    )
```

#### **ğŸ“Š Vector Search Logic**
```python
# Pseudo-code for VectorSearch
def search_documents(processed_query, user_permissions, max_results=5):
    # 1. Semantic search
    semantic_results = vector_db.similarity_search(
        query_vector=processed_query.embedding,
        top_k=max_results * 2  # Get more for filtering
    )
    
    # 2. Permission filtering
    filtered_results = []
    for result in semantic_results:
        if check_permission(result.metadata, user_permissions):
            filtered_results.append(result)
        if len(filtered_results) >= max_results:
            break
    
    # 3. Re-ranking based on multiple factors
    ranked_results = rerank_results(
        results=filtered_results,
        query_intent=processed_query.intent,
        user_context=user_context
    )
    
    return ranked_results
```

#### **ğŸ§© Context Building Logic**
```python
# Pseudo-code for ContextBuilder
def build_context(search_results, user_query, conversation_history):
    # 1. Extract relevant chunks
    context_chunks = []
    for result in search_results:
        chunk = {
            'content': result.page_content,
            'metadata': result.metadata,
            'relevance_score': result.score
        }
        context_chunks.append(chunk)
    
    # 2. Build system prompt
    system_prompt = f"""
    Báº¡n lÃ  trá»£ lÃ½ AI chuyÃªn vá» tri thá»©c ná»™i bá»™ cÃ´ng ty.
    HÃ£y tráº£ lá»i cÃ¢u há»i dá»±a trÃªn thÃ´ng tin Ä‘Æ°á»£c cung cáº¥p.
    Náº¿u khÃ´ng cÃ³ thÃ´ng tin phÃ¹ há»£p, hÃ£y nÃ³i ráº±ng báº¡n khÃ´ng biáº¿t.
    LuÃ´n Ä‘Æ°a ra trÃ­ch dáº«n tá»« tÃ i liá»‡u gá»‘c.
    """
    
    # 3. Build user prompt vá»›i context
    context_text = "\n\n".join([
        f"TÃ i liá»‡u {i+1}: {chunk['content']}" 
        for i, chunk in enumerate(context_chunks)
    ])
    
    user_prompt = f"""
    Ngá»¯ cáº£nh tÃ i liá»‡u:
    {context_text}
    
    CÃ¢u há»i: {user_query}
    
    Tráº£ lá»i:
    """
    
    return PromptContext(
        system_prompt=system_prompt,
        user_prompt=user_prompt,
        source_documents=context_chunks
    )
```

---

## 6. **ERROR HANDLING & RECOVERY**

### 6.1 Error Types & Recovery Strategies

```mermaid
flowchart TD
    Error([ğŸš¨ Error Occurred]) --> ErrorType{ğŸ” Error Type?}
    
    ErrorType -->|Network| NetworkError[ğŸŒ Network Error]
    ErrorType -->|LLM API| LLMError[ğŸ¤– LLM Error]  
    ErrorType -->|Database| DBError[ğŸ—„ï¸ Database Error]
    ErrorType -->|Permission| PermError[ğŸ›¡ï¸ Permission Error]
    ErrorType -->|Validation| ValidationError[âœ… Validation Error]
    ErrorType -->|System| SystemError[âš™ï¸ System Error]
    
    %% Network Error Recovery
    NetworkError --> NetworkRetry{ğŸ”„ Retry Count < 3?}
    NetworkRetry -->|Yes| WaitNetwork[â³ Exponential Backoff]
    WaitNetwork --> RetryNetwork[ğŸ”„ Retry Request]
    RetryNetwork --> NetworkSuccess{âœ… Success?}
    NetworkSuccess -->|No| NetworkRetry
    NetworkSuccess -->|Yes| LogSuccess[ğŸ“Š Log Success]
    NetworkRetry -->|No| NetworkFail[âŒ Return Network Error]
    
    %% LLM Error Recovery  
    LLMError --> LLMRetry{ğŸ”„ Primary LLM Failed?}
    LLMRetry -->|Yes| FallbackLLM[ğŸ”„ Try Backup LLM]
    FallbackLLM --> FallbackSuccess{âœ… Fallback Success?}
    FallbackSuccess -->|Yes| LogFallback[ğŸ“Š Log Fallback Used]
    FallbackSuccess -->|No| LocalLLM[ğŸ  Try Local LLM]
    LocalLLM --> LocalSuccess{âœ… Local Success?}
    LocalSuccess -->|Yes| LogLocal[ğŸ“Š Log Local Used]
    LocalSuccess -->|No| GenericResponse[ğŸ¤– Generic Response]
    
    %% Database Error Recovery
    DBError --> DBRetry{ğŸ”„ DB Connection Failed?}
    DBRetry -->|Yes| ReconnectDB[ğŸ”Œ Reconnect to DB]
    ReconnectDB --> ReadReplica{ğŸ“– Try Read Replica?}
    ReadReplica -->|Yes| ReplicaSuccess{âœ… Replica Success?}
    ReplicaSuccess -->|Yes| LogReplica[ğŸ“Š Log Replica Used]
    ReplicaSuccess -->|No| CacheOnly[ğŸ’¾ Use Cache Only]
    ReadReplica -->|No| CacheOnly
    CacheOnly --> CacheAvailable{ğŸ’¾ Cache Available?}
    CacheAvailable -->|Yes| ReturnCache[âš¡ Return Cached Data]
    CacheAvailable -->|No| DBUnavailable[âŒ DB Unavailable Error]
    
    %% Permission Error (No Recovery)
    PermError --> LogPermission[ğŸ“ Log Permission Denied]
    LogPermission --> Return403[ğŸš¨ Return 403 Forbidden]
    
    %% Validation Error (No Recovery)
    ValidationError --> LogValidation[ğŸ“ Log Validation Error]  
    LogValidation --> Return400[ğŸš¨ Return 400 Bad Request]
    
    %% System Error Recovery
    SystemError --> SystemRetry{ğŸ”„ System Resources?}
    SystemRetry -->|Available| RestartComponent[ğŸ”„ Restart Component]
    RestartComponent --> ComponentSuccess{âœ… Component OK?}
    ComponentSuccess -->|Yes| LogRestart[ğŸ“Š Log Component Restart]
    ComponentSuccess -->|No| SystemFail[âŒ System Failure]
    SystemRetry -->|Unavailable| SystemFail
    
    %% Success paths
    LogSuccess --> End([âœ… Success])
    LogFallback --> End
    LogLocal --> End  
    LogReplica --> End
    LogRestart --> End
    ReturnCache --> End
    GenericResponse --> End
    
    %% Failure paths
    NetworkFail --> Alert[ğŸš¨ Send Alert]
    DBUnavailable --> Alert
    SystemFail --> Alert
    Return403 --> End
    Return400 --> End
    Alert --> End([âŒ Failure])
    
    %% Styling
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef recovery fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef decision fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef success fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef failure fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    
    class Error,NetworkError,LLMError,DBError,PermError,ValidationError,SystemError error
    class WaitNetwork,RetryNetwork,FallbackLLM,LocalLLM,ReconnectDB,RestartComponent recovery
    class ErrorType,NetworkRetry,NetworkSuccess,LLMRetry,FallbackSuccess,LocalSuccess,DBRetry,ReadReplica,ReplicaSuccess,CacheAvailable,SystemRetry,ComponentSuccess decision
    class LogSuccess,LogFallback,LogLocal,LogReplica,LogRestart,ReturnCache,GenericResponse,End success
    class NetworkFail,DBUnavailable,SystemFail,Return403,Return400,Alert failure
```

### 6.2 Recovery Configuration

```python
# Error handling configuration
ERROR_CONFIG = {
    "network": {
        "max_retries": 3,
        "backoff_factor": 2,
        "timeout": 30
    },
    "llm": {
        "primary_timeout": 30,
        "fallback_providers": ["openai", "claude", "local"],
        "fallback_timeout": 60
    },
    "database": {
        "connection_retry": 3,
        "read_replica_fallback": True,
        "cache_fallback": True
    },
    "circuit_breaker": {
        "failure_threshold": 5,
        "timeout": 60,
        "expected_exception": ["ConnectionError", "Timeout"]
    }
}
```

### 6.3 Monitoring & Alerting Points

| Error Type | Alert Threshold | Action Required |
|------------|-----------------|-----------------|
| **Network Errors** | >5% in 5 minutes | Check network connectivity |
| **LLM Failures** | >10% in 10 minutes | Check API keys, quotas |
| **DB Connection** | Any failure | Immediate investigation |
| **Permission Denials** | >50 requests/hour | Review access policies |
| **System Resources** | >80% utilization | Scale infrastructure |

---

## 7. **TESTING STRATEGY**

### 7.1 Test Pyramid

```mermaid
graph TD
    subgraph "ğŸ§ª Testing Pyramid"
        E2E[ğŸŒ E2E Tests<br/>Full user journeys<br/>~10 tests]
        Integration[ğŸ”— Integration Tests<br/>Component interactions<br/>~50 tests]  
        Unit[âš™ï¸ Unit Tests<br/>Individual functions<br/>~200 tests]
    end
    
    subgraph "ğŸ¯ Test Categories"
        Functional[âœ… Functional Testing<br/>Feature correctness]
        Performance[âš¡ Performance Testing<br/>Speed & throughput]
        Security[ğŸ›¡ï¸ Security Testing<br/>Auth & permissions]
        Reliability[ğŸ”„ Reliability Testing<br/>Error handling]
    end
    
    subgraph "ğŸ› ï¸ Test Tools"
        PyTest[ğŸ PyTest<br/>Unit testing framework]
        FastAPI_Test[âš¡ FastAPI TestClient<br/>API testing]
        Locust[ğŸ¦— Locust<br/>Load testing]
        OWASP_ZAP[ğŸ›¡ï¸ OWASP ZAP<br/>Security scanning]
    end
    
    Unit --> Functional
    Integration --> Performance
    E2E --> Security
    E2E --> Reliability
    
    Functional --> PyTest
    Performance --> Locust
    Security --> OWASP_ZAP
    Reliability --> FastAPI_Test
    
    %% Styling
    classDef pyramid fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef category fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef tool fill:#fff3e0
